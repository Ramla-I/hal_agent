**General-purpose timers (TIM2 to TIM5)** **RM0041**

# **13 General-purpose timers (TIM2 to TIM5)**


**Low-density value line devices** are STM32F100xx microcontrollers where the flash
memory density ranges between 16 and 32 Kbytes.


**Medium-density value line devices** are STM32F100xx microcontrollers where the flash
memory density ranges between 64 and 128 Kbytes.


**High-density value line devices** are STM32F100xx microcontrollers where the flash
memory density ranges between 256 and 512 Kbytes.


_This_ section _applies to the whole STM32F100xx family, unless otherwise specified._

## **13.1 TIM2 to TIM5 introduction**


The general-purpose timers consist of a 16-bit auto-reload counter driven by a
programmable prescaler.


They may be used for a variety of purposes, including measuring the pulse lengths of input
signals ( _input capture_ ) or generating output waveforms ( _output compare and PWM_ ).


Pulse lengths and waveform periods can be modulated from a few microseconds to several
milliseconds using the timer prescaler and the RCC clock controller prescalers.


The timers are completely independent, and do not share any resources. They can be
synchronized together as described in _Section 13.3.15_ .


284/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**

## **13.2 TIM2 to TIM5 main features**


General-purpose TIMx timer features include:


      - 16-bit up, down, up/down auto-reload counter.


      - 16-bit programmable prescaler used to divide (also “on the fly”) the counter clock
frequency by any factor between 1 and 65536.


      - Up to 4 independent channels for:


–
Input capture


–
Output compare


–
PWM generation (Edge- and Center-aligned modes)


–
One-pulse mode output


      - Synchronization circuit to control the timer with external signals and to interconnect
several timers.


      - Interrupt/DMA generation on the following events:


–
Update: counter overflow/underflow, counter initialization (by software or
internal/external trigger)


–
Trigger event (counter start, stop, initialization or count by internal/external trigger)


–
Input capture


–
Output compare


      - Supports incremental (quadrature) encoder and hall-sensor circuitry for positioning

purposes


      - Trigger input for external clock or cycle-by-cycle current management


RM0041 Rev 6 285/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


**Figure 88. General-purpose timer block diagram**


















































|Col1|Col2|Col3|Col4|
|---|---|---|---|
||||te<br>|


|Col1|XOR|
|---|---|
|||
|||
|||












































## **13.3 TIM2 to TIM5 functional description**

**13.3.1** **Time-base unit**


The main block of the programmable timer is a 16-bit counter with its related auto-reload
register. The counter can count up but also down or both up and down. The counter clock
can be divided by a prescaler.


The counter, the auto-reload register and the prescaler register can be written or read by
software. This is true even when the counter is running.


The time-base unit includes:


      - Counter register (TIMx_CNT)


      - Prescaler register (TIMx_PSC):


      - Auto-Reload register (TIMx_ARR)


286/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


The auto-reload register is preloaded. Writing to or reading from the auto-reload register
accesses the preload register. The content of the preload register are transferred into the
shadow register permanently or at each update event (UEV), depending on the auto-reload
preload enable bit (ARPE) in TIMx_CR1 register. The update event is sent when the counter
reaches the overflow (or underflow when downcounting) and if the UDIS bit equals 0 in the
TIMx_CR1 register. It can also be generated by software. The generation of the update
event is described in detail for each configuration.


The counter is clocked by the prescaler output CK_CNT, which is enabled only when the
counter enable bit (CEN) in TIMx_CR1 register is set (refer also to the slave mode controller
description to get more details on counter enabling).


Note that the actual counter enable signal CNT_EN is set 1 clock cycle after CEN.


**Prescaler description**


The prescaler can divide the counter clock frequency by any factor between 1 and 65536. It
is based on a 16-bit counter controlled through a 16-bit register (in the TIMx_PSC register).
It can be changed on the fly as this control register is buffered. The new prescaler ratio is
taken into account at the next update event.


_Figure 89_ and _Figure 90_ give some examples of the counter behavior when the prescaler
ratio is changed on the fly:


**Figure 89. Counter timing diagram with prescaler division change from 1 to 2**







|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|F8|F9|FA|FB|FC|00|00|01|01|02|02|02|03|03|
|F8|F9|FA|FB|FC||||||||||
|F8||||||||||||||
|F8||||||||||||||
|F8||||||||||||||
|F8||||||||||||||
|F8|||||0|1|0|1|0|1|0|0|1|


RM0041 Rev 6 287/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


**Figure 90. Counter timing diagram with prescaler division change from 1 to 4**









**13.3.2** **Counter modes**


**Upcounting mode**




|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|
|---|---|---|---|---|---|---|---|---|---|---|---|---|
|F8|F9|FA|FB|FC|00|00|00|00|01|01|01|01|
|F8|F9|FA|FB|FC|||||||||
|F8|||||||||||||
|F8|||||||||||||
|F8|||||||||||||
|F8|||||||||||||
|F8|||||0|1|2|3|0|1|2|3|





In upcounting mode, the counter counts from 0 to the auto-reload value (content of the
TIMx_ARR register), then restarts from 0 and generates a counter overflow event.


An Update event can be generated at each counter overflow or by setting the UG bit in the
TIMx_EGR register (by software or by using the slave mode controller).


The UEV event can be disabled by software by setting the UDIS bit in TIMx_CR1 register.
This is to avoid updating the shadow registers while writing new values in the preload
registers. Then no update event occurs until the UDIS bit has been written to 0. However,
the counter restarts from 0, as well as the counter of the prescaler (but the prescale rate
does not change). In addition, if the URS bit (update request selection) in TIMx_CR1
register is set, setting the UG bit generates an update event UEV but without setting the UIF
flag (thus no interrupt or DMA request is sent). This is to avoid generating both update and
capture interrupts when clearing the counter on the capture event.


When an update event occurs, all the registers are updated and the update flag (UIF bit in
TIMx_SR register) is set (depending on the URS bit):


      - The buffer of the prescaler is reloaded with the preload value (content of the TIMx_PSC
register)


      - The auto-reload shadow register is updated with the preload value (TIMx_ARR)


The following figures show some examples of the counter behavior for different clock
frequencies when TIMx_ARR=0x36.


288/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


**Figure 91. Counter timing diagram, internal clock divided by 1**






|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|
|---|---|---|---|---|---|---|---|---|---|---|---|
|32|33|34|35|36|00<br>|02<br>01|03|04|05|06|07|



**Figure 92. Counter timing diagram, internal clock divided by 2**









**Figure 93. Counter timing diagram, internal clock divided by 4**





RM0041 Rev 6 289/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


**Figure 94. Counter timing diagram, internal clock divided by N**







**Figure 95. Counter timing diagram, Update event when ARPE=0 (TIMx_ARR not**
**preloaded)**






|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|
|---|---|---|---|---|---|---|---|---|---|---|---|---|
|32|33|34|35|36|00|01|02<br>|03|04|05|06|07|





290/709 RM0041 Rev 6




**RM0041** **General-purpose timers (TIM2 to TIM5)**


**Figure 96. Counter timing diagram, Update event when ARPE=1 (TIMx_ARR**
**preloaded)**






|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|
|---|---|---|---|---|---|---|---|---|---|---|---|---|
|F1|F2|F3|F4|F5|00|01|02|03|04|05|06|07|





**Downcounting mode**





In downcounting mode, the counter counts from the auto-reload value (content of the
TIMx_ARR register) down to 0, then restarts from the auto-reload value and generates a
counter underflow event.


An Update event can be generate at each counter underflow or by setting the UG bit in the
TIMx_EGR register (by software or by using the slave mode controller)


The UEV update event can be disabled by software by setting the UDIS bit in TIMx_CR1
register. This is to avoid updating the shadow registers while writing new values in the
preload registers. Then no update event occurs until UDIS bit has been written to 0.
However, the counter restarts from the current auto-reload value, whereas the counter of the
prescaler restarts from 0 (but the prescale rate does not change).


In addition, if the URS bit (update request selection) in TIMx_CR1 register is set, setting the
UG bit generates an update event UEV but without setting the UIF flag (thus no interrupt or
DMA request is sent). This is to avoid generating both update and capture interrupts when
clearing the counter on the capture event.


When an update event occurs, all the registers are updated and the update flag (UIF bit in
TIMx_SR register) is set (depending on the URS bit):


- The buffer of the prescaler is reloaded with the preload value (content of the TIMx_PSC
register).


- The auto-reload active register is updated with the preload value (content of the
TIMx_ARR register). Note that the auto-reload is updated before the counter is
reloaded, so that the next period is the expected one.


The following figures show some examples of the counter behavior for different clock
frequencies when TIMx_ARR=0x36.


RM0041 Rev 6 291/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


**Figure 97. Counter timing diagram, internal clock divided by 1**






|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|
|---|---|---|---|---|---|---|---|---|---|---|---|
|04|03 0|2<br>01|00|36|35|34<br>|33|32|31|30|2F|



**Figure 98. Counter timing diagram, internal clock divided by 2**







**Figure 99. Counter timing diagram, internal clock divided by 4**









292/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


**Figure 100. Counter timing diagram, internal clock divided by N**











**Figure 101. Counter timing diagram, Update event**






|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|
|---|---|---|---|---|---|---|---|---|---|---|---|---|
|04|03|02|01|00|36|35|34|33|32|31|30|2F|





**Center-aligned mode (up/down counting)**





In center-aligned mode, the counter counts from 0 to the auto-reload value (content of the
TIMx_ARR register) – 1, generates a counter overflow event, then counts from the autoreload value down to 1 and generates a counter underflow event. Then it restarts counting
from 0.


Center-aligned mode is active when the CMS bits in TIMx_CR1 register are not equal to
'00'. The Output compare interrupt flag of channels configured in output is set when: the
counter counts down (Center aligned mode 1, CMS = "01"), the counter counts up (Center
aligned mode 2, CMS = "10") the counter counts up and down (Center aligned mode 3,
CMS = "11").


RM0041 Rev 6 293/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


In this mode, the direction bit (DIR from TIMx_CR1 register) cannot be written. It is updated
by hardware and gives the current direction of the counter.


The update event can be generated at each counter overflow and at each counter underflow
or by setting the UG bit in the TIMx_EGR register (by software or by using the slave mode
controller) also generates an update event. In this case, the counter restarts counting from
0, as well as the counter of the prescaler.


The UEV update event can be disabled by software by setting the UDIS bit in TIMx_CR1
register. This is to avoid updating the shadow registers while writing new values in the
preload registers. Then no update event occurs until the UDIS bit has been written to 0.
However, the counter continues counting up and down, based on the current auto-reload
value.


In addition, if the URS bit (update request selection) in TIMx_CR1 register is set, setting the
UG bit generates an update event UEV but without setting the UIF flag (thus no interrupt or
DMA request is sent). This is to avoid generating both update and capture interrupt when
clearing the counter on the capture event.


When an update event occurs, all the registers are updated and the update flag (UIF bit in
TIMx_SR register) is set (depending on the URS bit):


      - The buffer of the prescaler is reloaded with the preload value (content of the TIMx_PSC
register).


      - The auto-reload active register is updated with the preload value (content of the
TIMx_ARR register). Note that if the update source is a counter overflow, the autoreload is updated before the counter is reloaded, so that the next period is the expected
one (the counter is loaded with the new value).


The following figures show some examples of the counter behavior for different clock
frequencies.


**Figure 102. Counter timing diagram, internal clock divided by 1, TIMx_ARR=0x6**






|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|
|---|---|---|---|---|---|---|---|---|---|---|---|---|
|03|02|01|00|01|02|03|04|05|06|05|04|03|
|03|02|01|||||||||||



1. Here, center-aligned mode 1 is used, for more details refer to _Section 13.4.1: TIMx control register 1 (TIMx_CR1)_ .


294/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


**Figure 103. Counter timing diagram, internal clock divided by 2**







**Figure 104. Counter timing diagram, internal clock divided by 4, TIMx_ARR=0x36**









1. Center-aligned mode 2 or 3 is used with an UIF on overflow.


**Figure 105. Counter timing diagram, internal clock divided by N**









RM0041 Rev 6 295/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


**Figure 106. Counter timing diagram, Update event with ARPE=1 (counter underflow)**








|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|
|---|---|---|---|---|---|---|---|---|---|---|---|---|
|05|04|03|02|01|00|01|02|03|04|05|06|07|





**Figure 107. Counter timing diagram, Update event with ARPE=1 (counter overflow)**






|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|
|---|---|---|---|---|---|---|---|---|---|---|---|---|
|F8|F9|FA|FB|FC|36|35|34|33|32|31|30|2F|





296/709 RM0041 Rev 6




**RM0041** **General-purpose timers (TIM2 to TIM5)**


**13.3.3** **Clock selection**


The counter clock can be provided by the following clock sources:


      - Internal clock (CK_INT)


      - External clock mode1: external input pin (TIx)


      - External clock mode2: external trigger input (ETR).


      - Internal trigger inputs (ITRx): using one timer as prescaler for another timer, for
example, Timer1 can be configured to act as a prescaler for Timer 2. Refer to _Using_
_one timer as prescaler for another timer_ for more details.


**Internal clock source (CK_INT)**


If the slave mode controller is disabled (SMS=000 in the TIMx_SMCR register), then the
CEN, DIR (in the TIMx_CR1 register) and UG bits (in the TIMx_EGR register) are actual
control bits and can be changed only by software (except UG which remains cleared
automatically). As soon as the CEN bit is written to 1, the prescaler is clocked by the internal
clock CK_INT.


_Figure 108_ shows the behavior of the control circuit and the upcounter in normal mode,
without prescaler.


**Figure 108. Control circuit in normal mode, internal clock divided by 1**






|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|||||||||||||||
|||||||||||||||
|||||||||||||||
|31|3 2|33|34|35|36|00|01|02|03|04|05|06|07|



**External clock source mode 1**


This mode is selected when SMS=111 in the TIMx_SMCR register. The counter can count at
each rising or falling edge on a selected input.


RM0041 Rev 6 297/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


**Figure 109. TI2 external clock connection example**











































For example, to configure the upcounter to count in response to a rising edge on the TI2
input, use the following procedure:


1. Configure channel 2 to detect rising edges on the TI2 input by writing CC2S= ‘01 in the
TIMx_CCMR1 register.


2. Configure the input filter duration by writing the IC2F[3:0] bits in the TIMx_CCMR1
register (if no filter is needed, keep IC2F=0000).


_Note:_ _The capture prescaler is not used for triggering, so there’s no need to configure it._


3. Select rising edge polarity by writing CC2P=0 and CC2NP=0 in the TIMx_CCER
register.


4. Configure the timer in external clock mode 1 by writing SMS=111 in the TIMx_SMCR
register.


5. Select TI2 as the input source by writing TS=110 in the TIMx_SMCR register.


6. Enable the counter by writing CEN=1 in the TIMx_CR1 register.


When a rising edge occurs on TI2, the counter counts once and the TIF flag is set.


The delay between the rising edge on TI2 and the actual clock of the counter is due to the
resynchronization circuit on TI2 input.


298/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


**Figure 110. Control circuit in external clock mode 1**


**External clock source mode 2**


This mode is selected by writing ECE=1 in the TIMx_SMCR register.


The counter can count at each rising or falling edge on the external trigger input ETR.


_Figure 111_ gives an overview of the external trigger input block.


**Figure 111. External trigger input block**



































For example, to configure the upcounter to count each 2 rising edges on ETR, use the
following procedure:


1. As no filter is needed in this example, write ETF[3:0]=0000 in the TIMx_SMCR register.


2. Set the prescaler by writing ETPS[1:0]=01 in the TIMx_SMCR register


3. Select rising edge detection on the ETR pin by writing ETP=0 in the TIMx_SMCR
register


4. Enable external clock mode 2 by writing ECE=1 in the TIMx_SMCR register.


5. Enable the counter by writing CEN=1 in the TIMx_CR1 register.


The counter counts once each 2 ETR rising edges.


RM0041 Rev 6 299/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


The delay between the rising edge on ETR and the actual clock of the counter is due to the
resynchronization circuit on the ETRP signal.


**Figure 112. Control circuit in external clock mode 2**



**13.3.4** **Capture/compare channels**




|Col1|Col2|Col3|
|---|---|---|
||35|35|





Each Capture/Compare channel (see _Figure 113_ ) is built around a capture/compare register
(including a shadow register), an input stage for capture (with digital filter, multiplexing and
prescaler) and an output stage (with comparator and output control).


The input stage samples the corresponding TIx input to generate a filtered signal TIxF.
Then, an edge detector with polarity selection generates a signal (TIxFPx) which can be
used as trigger input by the slave mode controller or as the capture command. It is
prescaled before the capture register (ICxPS).


**Figure 113. Capture/compare channel (example: channel 1 input stage)**















































300/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


The output stage generates an intermediate waveform which is then used for reference:
OCxRef (active high). The polarity acts at the end of the chain.


**Figure 114. Capture/compare channel 1 main circuit**























































**Figure 115. Output stage of capture/compare channel (channel 1)**



























The capture/compare block is made of one preload register and one shadow register. Write
and read always access the preload register.


In capture mode, captures are actually done in the shadow register, which is copied into the
preload register.


In compare mode, the content of the preload register is copied into the shadow register
which is compared to the counter.


RM0041 Rev 6 301/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


**13.3.5** **Input capture mode**


In Input capture mode, the Capture/Compare registers (TIMx_CCRx) are used to latch the
value of the counter after a transition detected by the corresponding ICx signal. When a
capture occurs, the corresponding CCXIF flag (TIMx_SR register) is set and an interrupt or
a DMA request can be sent if they are enabled. If a capture occurs while the CCxIF flag was
already high, then the over-capture flag CCxOF (TIMx_SR register) is set. CCxIF can be
cleared by software by writing it to 0 or by reading the captured data stored in the
TIMx_CCRx register. CCxOF is cleared when written to 0.


The following example shows how to capture the counter value in TIMx_CCR1 when TI1
input rises. To do this, use the following procedure:


      - Select the active input: TIMx_CCR1 must be linked to the TI1 input, so write the CC1S
bits to 01 in the TIMx_CCMR1 register. As soon as CC1S becomes different from 00,
the channel is configured in input and the TIMx_CCR1 register becomes read-only.


      - Program the needed input filter duration with respect to the signal connected to the
timer (by programming the ICxF bits in the TIMx_CCMRx register if the input is one of
the TIx inputs). Let’s imagine that, when toggling, the input signal is not stable during at
must five internal clock cycles. We must program a filter duration longer than these five
clock cycles. We can validate a transition on TI1 when eight consecutive samples with
the new level have been detected (sampled at f DTS frequency). Then write IC1F bits to
0011 in the TIMx_CCMR1 register.


      - Select the edge of the active transition on the TI1 channel by writing the CC1P bit to 0
in the TIMx_CCER register (rising edge in this case).


      - Program the input prescaler. In our example, we wish the capture to be performed at
each valid transition, so the prescaler is disabled (write IC1PS bits to 00 in the
TIMx_CCMR1 register).


      - Enable capture from the counter into the capture register by setting the CC1E bit in the
TIMx_CCER register.


      - If needed, enable the related interrupt request by setting the CC1IE bit in the
TIMx_DIER register, and/or the DMA request by setting the CC1DE bit in the
TIMx_DIER register.


When an input capture occurs:


      - The TIMx_CCR1 register gets the value of the counter on the active transition.


      - CC1IF flag is set (interrupt flag). CC1OF is also set if at least two consecutive captures
occurred whereas the flag was not cleared.


      - An interrupt is generated depending on the CC1IE bit.


      - A DMA request is generated depending on the CC1DE bit.


In order to handle the overcapture, it is recommended to read the data before the
overcapture flag. This is to avoid missing an overcapture which could happen after reading
the flag and before reading the data.


_Note:_ _IC interrupt and/or DMA requests can be generated by software by setting the_
_corresponding CCxG bit in the TIMx_EGR register._


302/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


**13.3.6** **PWM input mode**


This mode is a particular case of input capture mode. The procedure is the same except:


      - Two ICx signals are mapped on the same TIx input.


      - These 2 ICx signals are active on edges with opposite polarity.


      - One of the two TIxFP signals is selected as trigger input and the slave mode controller
is configured in reset mode.


For example, the user can measure the period (in TIMx_CCR1 register) and the duty cycle
(in TIMx_CCR2 register) of the PWM applied on TI1 using the following procedure
(depending on CK_INT frequency and prescaler value):


      - Select the active input for TIMx_CCR1: write the CC1S bits to 01 in the TIMx_CCMR1
register (TI1 selected).


      - Select the active polarity for TI1FP1 (used both for capture in TIMx_CCR1 and counter
clear): write the CC1P to ‘0’ (active on rising edge).


      - Select the active input for TIMx_CCR2: write the CC2S bits to 10 in the TIMx_CCMR1
register (TI1 selected).


      - Select the active polarity for TI1FP2 (used for capture in TIMx_CCR2): write the CC2P
bit to ‘1’ (active on falling edge).


      - Select the valid trigger input: write the TS bits to 101 in the TIMx_SMCR register
(TI1FP1 selected).


      - Configure the slave mode controller in reset mode: write the SMS bits to 100 in the
TIMx_SMCR register.


      - Enable the captures: write the CC1E and CC2E bits to ‘1 in the TIMx_CCER register.


**Figure 116. PWM input mode timing**











RM0041 Rev 6 303/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


**13.3.7** **Forced output mode**


In output mode (CCxS bits = 00 in the TIMx_CCMRx register), each output compare signal
(OCxREF and then OCx) can be forced to active or inactive level directly by software,
independently of any comparison between the output compare register and the counter.


To force an output compare signal (ocxref/OCx) to its active level, the user just needs to
write 101 in the OCxM bits in the corresponding TIMx_CCMRx register. Thus ocxref is
forced high (OCxREF is always active high) and OCx get opposite value to CCxP polarity
bit.


e.g.: CCxP=0 (OCx active high) => OCx is forced to high level.


ocxref signal can be forced low by writing the OCxM bits to 100 in the TIMx_CCMRx
register.


Anyway, the comparison between the TIMx_CCRx shadow register and the counter is still
performed and allows the flag to be set. Interrupt and DMA requests can be sent
accordingly. This is described in the next section.


**13.3.8** **Output compare mode**


This function is used to control an output waveform or indicating when a period of time has
elapsed.


When a match is found between the capture/compare register and the counter, the output
compare function:


      - Assigns the corresponding output pin to a programmable value defined by the output
compare mode (OCxM bits in the TIMx_CCMRx register) and the output polarity (CCxP
bit in the TIMx_CCER register). The output pin can keep its level (OCXM=000), be set
active (OCxM=001), be set inactive (OCxM=010) or can toggle (OCxM=011) on match.


      - Sets a flag in the interrupt status register (CCxIF bit in the TIMx_SR register).


      - Generates an interrupt if the corresponding interrupt mask is set (CCXIE bit in the
TIMx_DIER register).


      - Sends a DMA request if the corresponding enable bit is set (CCxDE bit in the
TIMx_DIER register, CCDS bit in the TIMx_CR2 register for the DMA request
selection).


The TIMx_CCRx registers can be programmed with or without preload registers using the
OCxPE bit in the TIMx_CCMRx register.


In output compare mode, the update event UEV has no effect on ocxref and OCx output.
The timing resolution is one count of the counter. Output compare mode can also be used to
output a single pulse (in One-pulse mode).


Procedure:


1. Select the counter clock (internal, external, prescaler).


2. Write the desired data in the TIMx_ARR and TIMx_CCRx registers.


3. Set the CCxIE and/or CCxDE bits if an interrupt and/or a DMA request is to be
generated.


4. Select the output mode. For example, the user must write OCxM=011, OCxPE=0,
CCxP=0 and CCxE=1 to toggle OCx output pin when CNT matches CCRx, CCRx
preload is not used, OCx is enabled and active high.


5. Enable the counter by setting the CEN bit in the TIMx_CR1 register.


304/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


The TIMx_CCRx register can be updated at any time by software to control the output
waveform, provided that the preload register is not enabled (OCxPE=0, else TIMx_CCRx
shadow register is updated only at the next update event UEV). An example is given in
_Figure 117_ .


**Figure 117. Output compare mode, toggle on OC1**









**13.3.9** **PWM mode**









Pulse width modulation mode allows generating a signal with a frequency determined by the
value of the TIMx_ARR register and a duty cycle determined by the value of the
TIMx_CCRx register.


The PWM mode can be selected independently on each channel (one PWM per OCx
output) by writing 110 (PWM mode 1) or ‘111 (PWM mode 2) in the OCxM bits in the
TIMx_CCMRx register. The user must enable the corresponding preload register by setting
the OCxPE bit in the TIMx_CCMRx register, and eventually the auto-reload preload register
by setting the ARPE bit in the TIMx_CR1 register.


As the preload registers are transferred to the shadow registers only when an update event
occurs, before starting the counter, the user has to initialize all the registers by setting the
UG bit in the TIMx_EGR register.


OCx polarity is software programmable using the CCxP bit in the TIMx_CCER register. It
can be programmed as active high or active low. OCx output is enabled by the CCxE bit in
the TIMx_CCER register. Refer to the TIMx_CCERx register description for more details.


In PWM mode (1 or 2), TIMx_CNT and TIMx_CCRx are always compared to determine
whether TIMx_CCRx≤TIMx_CNT or TIMx_CNT≤TIMx_CCRx (depending on the direction of
the counter). However, to comply with the ETRF (OCREF can be cleared by an external
event through the ETR signal until the next PWM period), the OCREF signal is asserted
only:


- When the result of the comparison changes, or


- When the output compare mode (OCxM bits in TIMx_CCMRx register) switches from
the “frozen” configuration (no comparison, OCxM=‘000) to one of the PWM modes
(OCxM=‘110 or ‘111).


This forces the PWM by software while the timer is running.


RM0041 Rev 6 305/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


The timer is able to generate PWM in edge-aligned mode or center-aligned mode
depending on the CMS bits in the TIMx_CR1 register.


**PWM edge-aligned mode**


**Upcounting configuration**


Upcounting is active when the DIR bit in the TIMx_CR1 register is low. Refer to _Upcounting_
_mode_ .


In the following example, we consider PWM mode 1. The reference PWM signal OCxREF is
high as long as TIMx_CNT <TIMx_CCRx else it becomes low. If the compare value in
TIMx_CCRx is greater than the auto-reload value (in TIMx_ARR) then OCxREF is held at ‘1.
If the compare value is 0 then OCxREF is held at ‘0. _Figure 118_ shows some edge-aligned
PWM waveforms in an example where TIMx_ARR=8.


**Figure 118. Edge-aligned PWM waveforms (ARR=8)**






|0|1|2|3|4|5|
|---|---|---|---|---|---|
|||||||
|||||||


|Col1|7|8|0|1|
|---|---|---|---|---|
||7||||
||||||
||||||
||||||





**Downcounting configuration**


Downcounting is active when DIR bit in TIMx_CR1 register is high. Refer to _Downcounting_
_mode_ .


In PWM mode 1, the reference signal ocxref is low as long as TIMx_CNT>TIMx_CCRx else
it becomes high. If the compare value in TIMx_CCRx is greater than the auto-reload value in
TIMx_ARR, then ocxref is held at ‘1. 0% PWM is not possible in this mode.


**PWM center-aligned mode**


Center-aligned mode is active when the CMS bits in TIMx_CR1 register are different from
‘00 (all the remaining configurations having the same effect on the ocxref/OCx signals). The
compare flag is set when the counter counts up, when it counts down or both when it counts


306/709 RM0041 Rev 6


|Col1|Col2|Col3|General-purpose timers (TIM2 to TIM5)|Col5|Col6|Col7|
|---|---|---|---|---|---|---|
|up and down depending on the CMS bits conf<br>TIMx_CR1 register is updated by hardware an<br>_Center-aligned mode (up/down counting)_.<br>_Figure 119_ shows some center-aligned PWM<br>•<br>TIMx_ARR=8,<br>•<br>PWM mode is the PWM mode 1,<br>•<br>The flag is set when the counter counts d<br>mode 1 selected for CMS=01 in TIMx_C<br>**Figure 119. Center-aligned**|up and down depending on the CMS bits conf<br>TIMx_CR1 register is updated by hardware an<br>_Center-aligned mode (up/down counting)_.<br>_Figure 119_ shows some center-aligned PWM<br>•<br>TIMx_ARR=8,<br>•<br>PWM mode is the PWM mode 1,<br>•<br>The flag is set when the counter counts d<br>mode 1 selected for CMS=01 in TIMx_C<br>**Figure 119. Center-aligned**|up and down depending on the CMS bits conf<br>TIMx_CR1 register is updated by hardware an<br>_Center-aligned mode (up/down counting)_.<br>_Figure 119_ shows some center-aligned PWM<br>•<br>TIMx_ARR=8,<br>•<br>PWM mode is the PWM mode 1,<br>•<br>The flag is set when the counter counts d<br>mode 1 selected for CMS=01 in TIMx_C<br>**Figure 119. Center-aligned**|iguration. The direction bit (DIR) in the<br>d must not be changed by software. Refer to<br>waveforms in an example where:<br>own corresponding to the center-aligned<br>R1 register.<br>** PWM waveforms (ARR=8)**|iguration. The direction bit (DIR) in the<br>d must not be changed by software. Refer to<br>waveforms in an example where:<br>own corresponding to the center-aligned<br>R1 register.<br>** PWM waveforms (ARR=8)**|iguration. The direction bit (DIR) in the<br>d must not be changed by software. Refer to<br>waveforms in an example where:<br>own corresponding to the center-aligned<br>R1 register.<br>** PWM waveforms (ARR=8)**|iguration. The direction bit (DIR) in the<br>d must not be changed by software. Refer to<br>waveforms in an example where:<br>own corresponding to the center-aligned<br>R1 register.<br>** PWM waveforms (ARR=8)**|
|CCxIF<br>0<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>7<br>6<br>5<br>4<br>3<br>2<br>1<br>0<br>1<br>Counter register<br>CCRx = 4<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>CCxIF<br>CCRx = 7<br>OCxREF<br>CMS=10 or 11<br>CCxIF<br>CCRx = 8<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>'1'<br>CCxIF<br>CCRx > 8<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>'1'<br>CCxIF<br>CCRx = 0<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>'0'<br>ai14681b|0<br>1<br>2<br>3|4<br>5<br>6|7|8|7<br>6<br>5|4<br>3<br>2<br>1|
|CCxIF<br>0<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>7<br>6<br>5<br>4<br>3<br>2<br>1<br>0<br>1<br>Counter register<br>CCRx = 4<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>CCxIF<br>CCRx = 7<br>OCxREF<br>CMS=10 or 11<br>CCxIF<br>CCRx = 8<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>'1'<br>CCxIF<br>CCRx > 8<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>'1'<br>CCxIF<br>CCRx = 0<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>'0'<br>ai14681b|0<br>1<br>2<br>3|4<br>5<br>6|||||
|CCxIF<br>0<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>7<br>6<br>5<br>4<br>3<br>2<br>1<br>0<br>1<br>Counter register<br>CCRx = 4<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>CCxIF<br>CCRx = 7<br>OCxREF<br>CMS=10 or 11<br>CCxIF<br>CCRx = 8<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>'1'<br>CCxIF<br>CCRx > 8<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>'1'<br>CCxIF<br>CCRx = 0<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>'0'<br>ai14681b|0<br>1<br>2<br>3|4<br>5<br>6|||||
|CCxIF<br>0<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>7<br>6<br>5<br>4<br>3<br>2<br>1<br>0<br>1<br>Counter register<br>CCRx = 4<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>CCxIF<br>CCRx = 7<br>OCxREF<br>CMS=10 or 11<br>CCxIF<br>CCRx = 8<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>'1'<br>CCxIF<br>CCRx > 8<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>'1'<br>CCxIF<br>CCRx = 0<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>'0'<br>ai14681b|0<br>1<br>2<br>3|4<br>5<br>6|||||
|CCxIF<br>0<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>7<br>6<br>5<br>4<br>3<br>2<br>1<br>0<br>1<br>Counter register<br>CCRx = 4<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>CCxIF<br>CCRx = 7<br>OCxREF<br>CMS=10 or 11<br>CCxIF<br>CCRx = 8<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>'1'<br>CCxIF<br>CCRx > 8<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>'1'<br>CCxIF<br>CCRx = 0<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>'0'<br>ai14681b|CMS=01<br>CMS=10<br>CMS=11|CMS=01<br>CMS=10<br>CMS=11|CMS=01<br>CMS=10<br>CMS=11||||
|CCxIF<br>0<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>7<br>6<br>5<br>4<br>3<br>2<br>1<br>0<br>1<br>Counter register<br>CCRx = 4<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>CCxIF<br>CCRx = 7<br>OCxREF<br>CMS=10 or 11<br>CCxIF<br>CCRx = 8<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>'1'<br>CCxIF<br>CCRx > 8<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>'1'<br>CCxIF<br>CCRx = 0<br>OCxREF<br>CMS=01<br>CMS=10<br>CMS=11<br>'0'<br>ai14681b|CMS=01<br>CMS=10<br>CMS=11|CMS=01<br>CMS=10<br>CMS=11|CMS=01<br>CMS=10<br>CMS=11||||


Hints on using center-aligned mode:


- When starting in center-aligned mode, the current up-down configuration is used. It
means that the counter counts up or down depending on the value written in the DIR bit


RM0041 Rev 6 307/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


in the TIMx_CR1 register. Moreover, the DIR and CMS bits must not be changed at the
same time by the software.


      - Writing to the counter while running in center-aligned mode is not recommended as it
can lead to unexpected results. In particular:


–
The direction is not updated if the user writes a value in the counter that is greater
than the auto-reload value (TIMx_CNT>TIMx_ARR). For example, if the counter
was counting up, it continues to count up.


–
The direction is updated if the user writes 0 or write the TIMx_ARR value in the
counter but no Update Event UEV is generated.


      - The safest way to use center-aligned mode is to generate an update by software
(setting the UG bit in the TIMx_EGR register) just before starting the counter and not to
write the counter while it is running.


**13.3.10** **One-pulse mode**


One-pulse mode (OPM) is a particular case of the previous modes. It allows the counter to
be started in response to a stimulus and to generate a pulse with a programmable length
after a programmable delay.


Starting the counter can be controlled through the slave mode controller. Generating the
waveform can be done in output compare mode or PWM mode. Select One-pulse mode by
setting the OPM bit in the TIMx_CR1 register. This makes the counter stop automatically at
the next update event UEV.


A pulse can be correctly generated only if the compare value is different from the counter
initial value. Before starting (when the timer is waiting for the trigger), the configuration must
be:


      - In upcounting: CNT<CCRx≤ARR (in particular, 0<CCRx),


      - In downcounting: CNT>CCRx.


**Figure 120. Example of one-pulse mode**







For example the user may want to generate a positive pulse on OC1 with a length of t PULSE
and after a delay of t DELAY as soon as a positive edge is detected on the TI2 input pin.


308/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


Let’s use TI2FP2 as trigger 1:


      - Map TI2FP2 on TI2 by writing CC2S=01 in the TIMx_CCMR1 register.


      - TI2FP2 must detect a rising edge, write CC2P=0 in the TIMx_CCER register.


      - Configure TI2FP2 as trigger for the slave mode controller (TRGI) by writing TS=110 in
the TIMx_SMCR register.


      - TI2FP2 is used to start the counter by writing SMS to ‘110 in the TIMx_SMCR register
(trigger mode).


The OPM waveform is defined by writing the compare registers (taking into account the
clock frequency and the counter prescaler).


      - The t DELAY is defined by the value written in the TIMx_CCR1 register.


      - The t PULSE is defined by the difference between the auto-reload value and the compare
value (TIMx_ARR - TIMx_CCR + 1).


      - Let us say user wants to build a waveform with a transition from ‘0 to ‘1 when a
compare match occurs and a transition from ‘1 to ‘0 when the counter reaches the
auto-reload value. To do this enable PWM mode 2 by writing OC1M=111 in the
TIMx_CCMR1 register. The user can optionally enable the preload registers by writing
OC1PE=1 in the TIMx_CCMR1 register and ARPE in the TIMx_CR1 register. In this
case write the compare value in the TIMx_CCR1 register, the auto-reload value in the
TIMx_ARR register, generate an update by setting the UG bit and wait for external
trigger event on TI2. CC1P is written to ‘0 in this example.


In our example, the DIR and CMS bits in the TIMx_CR1 register should be low.


User only wants one pulse (Single mode), so write '1 in the OPM bit in the TIMx_CR1
register to stop the counter at the next update event (when the counter rolls over from the
auto-reload value back to 0). When OPM bit in the TIMx_CR1 register is set to '0', so the
Repetitive mode is selected.


**Particular case: OCx fast enable:**


In One-pulse mode, the edge detection on TIx input set the CEN bit which enables the
counter. Then the comparison between the counter and the compare value makes the
output toggle. But several clock cycles are needed for these operations and it limits the
minimum delay t DELAY min we can get.


To output a waveform with the minimum delay, the user can set the OCxFE bit in the
TIMx_CCMRx register. Then OCxRef (and OCx) is forced in response to the stimulus,
without taking in account the comparison. Its new level is the same as if a compare match
had occurred. OCxFE acts only if the channel is configured in PWM1 or PWM2 mode.


**13.3.11** **Clearing the OCxREF signal on an external event**


The OCxREF signal for a given channel can be driven Low by applying a High level to the
ETRF input (OCxCE enable bit of the corresponding TIMx_CCMRx register set to '1'). The
OCxREF signal remains Low until the next update event, UEV, occurs.


This function can only be used in output compare and PWM modes, and does not work in
forced mode.


For example, the ETR signal can be connected to the output of a comparator to be used for
current handling. In this case, ETR must be configured as follows:


RM0041 Rev 6 309/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


1. The external trigger prescaler should be kept off: bits ETPS[1:0] in the TIMx_SMCR
register are cleared to 00.


2. The external clock mode 2 must be disabled: bit ECE in the TIM1_SMCR register is
cleared to 0.


3. The external trigger polarity (ETP) and the external trigger filter (ETF) can be
configured according to the application’s needs.


_Figure 121_ shows the behavior of the OCxREF signal when the ETRF input becomes high,
for both values of the OCxCE enable bit. In this example, the timer TIMx is programmed in
PWM mode.


**Figure 121. Clearing TIMx OCxREF**


_Note:_ _In case of a PWM with a 100% duty cycle (if CCRx>ARR), OCxREF is enabled again at the_
_next counter overflow._


**13.3.12** **Encoder interface mode**


To select Encoder Interface mode write SMS=‘001 in the TIMx_SMCR register if the counter
is counting on TI2 edges only, SMS=010 if it is counting on TI1 edges only and SMS=011 if
it is counting on both TI1 and TI2 edges.


Select the TI1 and TI2 polarity by programming the CC1P and CC2P bits in the TIMx_CCER
register. CC1NP and CC2NP must be kept cleared. When needed, program the input filter
as well.


The two inputs TI1 and TI2 are used to interface to an incremental encoder. Refer to
_Table 70_ . The counter is clocked by each valid transition on TI1FP1 or TI2FP2 (TI1 and TI2
after input filter and polarity selection, TI1FP1=TI1 if not filtered and not inverted,
TI2FP2=TI2 if not filtered and not inverted) assuming that it is enabled (CEN bit in
TIMx_CR1 register written to ‘1). The sequence of transitions of the two inputs is evaluated
and generates count pulses as well as the direction signal. Depending on the sequence the
counter counts up or down, the DIR bit in the TIMx_CR1 register is modified by hardware
accordingly. The DIR bit is calculated at each transition on any input (TI1 or TI2), whatever
the counter is counting on TI1 only, TI2 only or both TI1 and TI2.


Encoder interface mode acts simply as an external clock with direction selection. This
means that the counter just counts continuously between 0 and the auto-reload value in the
TIMx_ARR register (0 to ARR or ARR down to 0 depending on the direction). So the user


310/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


must configure TIMx_ARR before starting. In the same way, the capture, compare,
prescaler, trigger output features continue to work as normal.


In this mode, the counter is modified automatically following the speed and the direction of
the incremental encoder and its content, therefore, always represents the encoder’s
position. The count direction correspond to the rotation direction of the connected sensor.
The table summarizes the possible combinations, assuming TI1 and TI2 do not switch at the
same time.


**Table 70. Counting direction versus encoder signals**










|Active edge|Level on opposite<br>signal (TI1FP1 for<br>TI2, TI2FP2 for TI1)|TI1FP1 signal|Col4|TI2FP2 signal|Col6|
|---|---|---|---|---|---|
|**Active edge**|**Level on opposite**<br>**signal (TI1FP1 for**<br>**TI2, TI2FP2 for TI1)**|**Rising**|**Falling**|**Rising**|**Falling**|
|Counting on<br>TI1 only|High|Down|Up|No Count|No Count|
|Counting on<br>TI1 only|Low|Up|Down|No Count|No Count|
|Counting on<br>TI2 only|High|No Count|No Count|Up|Down|
|Counting on<br>TI2 only|Low|No Count|No Count|Down|Up|
|Counting on<br>TI1 and TI2|High|Down|Up|Up|Down|
|Counting on<br>TI1 and TI2|Low|Up|Down|Down|Up|



An external incremental encoder can be connected directly to the MCU without external
interface logic. However, comparators are normally be used to convert the encoder’s
differential outputs to digital signals. This greatly increases noise immunity. The third
encoder output which indicate the mechanical zero position, may be connected to an
external interrupt input and trigger a counter reset.


_Figure 122_ gives an example of counter operation, showing count signal generation and
direction control. It also shows how input jitter is compensated where both edges are
selected. This might occur if the sensor is positioned near to one of the switching points. For
this example we assume that the configuration is the following:


- CC1S= ‘01’ (TIMx_CCMR1 register, TI1FP1 mapped on TI1)


- CC2S= ‘01’ (TIMx_CCMR2 register, TI2FP2 mapped on TI2)


- CC1P= ‘0’, CC1NP = ‘0’, IC1F =’0000’ (TIMx_CCER register, TI1FP1 noninverted,
TI1FP1=TI1)


- CC2P= ‘0’, CC2NP = ‘0’, IC2F =’0000’ (TIMx_CCER register, TI2FP2 noninverted,
TI2FP2=TI2)


- SMS= ‘011’ (TIMx_SMCR register, both inputs are active on both rising and falling
edges)


- CEN = 1 (TIMx_CR1 register, Counter is enabled)


RM0041 Rev 6 311/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


**Figure 122. Example of counter operation in encoder interface mode**





_Figure 123_ gives an example of counter behavior when TI1FP1 polarity is inverted (same
configuration as above except CC1P=1).


**Figure 123. Example of encoder interface mode with TI1FP1 polarity inverted**







The timer, when configured in Encoder Interface mode provides information on the sensor’s
current position. The user can obtain dynamic information (speed, acceleration,
deceleration) by measuring the period between two encoder events using a second timer
configured in capture mode. The output of the encoder which indicates the mechanical zero
can be used for this purpose. Depending on the time between two events, the counter can
also be read at regular times. The user can do this by latching the counter value into a third
input capture register if available (then the capture signal must be periodic and can be
generated by another timer). when available, it is also possible to read its value through a
DMA request generated by a Real-Time clock.


312/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


**13.3.13** **Timer input XOR function**


The TI1S bit in the TIM1_CR2 register, allows the input filter of channel 1 to be connected to
the output of a XOR gate, combining the three input pins TIMx_CH1 to TIMx_CH3.


The XOR output can be used with all the timer input functions such as trigger or input
capture.


An example of this feature used to interface Hall sensors is given in _Section 12.3.18_ .


**13.3.14** **Timers and external trigger synchronization**


The TIMx Timers can be synchronized with an external trigger in several modes: Reset
mode, Gated mode and Trigger mode.


**Slave mode: Reset mode**


The counter and its prescaler can be reinitialized in response to an event on a trigger input.
Moreover, if the URS bit from the TIMx_CR1 register is low, an update event UEV is
generated. Then all the preloaded registers (TIMx_ARR, TIMx_CCRx) are updated.


In the following example, the upcounter is cleared in response to a rising edge on TI1 input:


      - Configure the channel 1 to detect rising edges on TI1. Configure the input filter duration
(in this example, no need of any filter, IC1F=0000 kept). The capture prescaler is not
used for triggering, so the user does not need to configure it. The CC1S bits select the
input capture source only, CC1S = 01 in the TIMx_CCMR1 register. Write CC1P=0 and
CC1NP=0 in TIMx_CCER register to validate the polarity (and detect rising edges
only).


      - Configure the timer in reset mode by writing SMS=100 in TIMx_SMCR register. Select
TI1 as the input source by writing TS=101 in TIMx_SMCR register.


      - Start the counter by writing CEN=1 in the TIMx_CR1 register.


The counter starts counting on the internal clock, then behaves normally until TI1 rising
edge. When TI1 rises, the counter is cleared and restarts from 0. In the meantime, the
trigger flag is set (TIF bit in the TIMx_SR register) and an interrupt request, or a DMA
request can be sent if enabled (depending on the TIE and TDE bits in TIMx_DIER register).


_Figure 124_ shows this behavior when the auto-reload register TIMx_ARR=0x36. The delay
between the rising edge on TI1 and the actual reset of the counter is due to the
resynchronization circuit on TI1 input.


**Figure 124. Control circuit in reset mode**








|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|31|32|33|34|35|36|00|01|02|03|00|01|02|03||



RM0041 Rev 6 313/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


**Slave mode: Gated mode**


The counter can be enabled depending on the level of a selected input.


In the following example, the upcounter counts only when TI1 input is low:


      - Configure the channel 1 to detect low levels on TI1. Configure the input filter duration
(in this example, no need of any filter, IC1F=0000 kept). The capture prescaler is not
used for triggering, so the user does not need to configure it. The CC1S bits select the
input capture source only, CC1S=01 in TIMx_CCMR1 register. Write CC1P=1 and
CC1NP=0 in TIMx_CCER register to validate the polarity (and detect low level only).


      - Configure the timer in gated mode by writing SMS=101 in TIMx_SMCR register. Select
TI1 as the input source by writing TS=101 in TIMx_SMCR register.


      - Enable the counter by writing CEN=1 in the TIMx_CR1 register (in gated mode, the
counter does not start if CEN=0, whatever is the trigger input level).


The counter starts counting on the internal clock as long as TI1 is low and stops as soon as
TI1 becomes high. The TIF flag in the TIMx_SR register is set both when the counter starts
or stops.


The delay between the rising edge on TI1 and the actual stop of the counter is due to the
resynchronization circuit on TI1 input.


**Figure 125. Control circuit in gated mode**







_Note:_ _The configuration “CCxP=CCxNP=1” (detection of both rising and falling edges) does not_
_have any effect in gated mode because gated mode acts on a level and not on an edge._


**Slave mode: Trigger mode**


The counter can start in response to an event on a selected input.


In the following example, the upcounter starts in response to a rising edge on TI2 input:


      - Configure the channel 2 to detect rising edges on TI2. Configure the input filter duration
(in this example, no need of any filter, IC2F=0000 kept). The capture prescaler is not
used for triggering, so the user does not need to configure it. CC2S bits are selecting
the input capture source only, CC2S=01 in TIMx_CCMR1 register. Write CC2P=1 and
CC2NP=0 in TIMx_CCER register to validate the polarity (and detect low level only).


      - Configure the timer in trigger mode by writing SMS=110 in TIMx_SMCR register. Select
TI2 as the input source by writing TS=110 in TIMx_SMCR register.


314/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


When a rising edge occurs on TI2, the counter starts counting on the internal clock and the
TIF flag is set.


The delay between the rising edge on TI2 and the actual start of the counter is due to the
resynchronization circuit on TI2 input.


**Figure 126. Control circuit in trigger mode**



**Slave mode: External Clock mode 2 + trigger mode**





The external clock mode 2 can be used in addition to another slave mode (except external
clock mode 1 and encoder mode). In this case, the ETR signal is used as external clock
input, and another input can be selected as trigger input when operating in reset mode,
gated mode or trigger mode. It is recommended not to select ETR as TRGI through the TS
bits of TIMx_SMCR register.


In the following example, the upcounter is incremented at each rising edge of the ETR
signal as soon as a rising edge of TI1 occurs:


1. Configure the external trigger input circuit by programming the TIMx_SMCR register as
follows:


– ETF = 0000: no filter


–
ETPS = 00: prescaler disabled


–
ETP = 0: detection of rising edges on ETR and ECE=1 to enable the external clock
mode 2.


2. Configure the channel 1 as follows, to detect rising edges on TI:


– IC1F = 0000: no filter.


–
The capture prescaler is not used for triggering and does not need to be
configured.


–
CC1S = 01 in TIMx_CCMR1 register to select only the input capture source


–
CC1P = 0 and CC1NP = 0 in TIMx_CCER register to validate the polarity (and
detect rising edge only).


3. Configure the timer in trigger mode by writing SMS=110 in TIMx_SMCR register. Select
TI1 as the input source by writing TS=101 in TIMx_SMCR register.


A rising edge on TI1 enables the counter and sets the TIF flag. The counter then counts on
ETR rising edges.


The delay between the rising edge of the ETR signal and the actual reset of the counter is
due to the resynchronization circuit on ETRP input.


RM0041 Rev 6 315/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


**Figure 127. Control circuit in external clock mode 2 + trigger mode**



**13.3.15** **Timer synchronization**




|Col1|Col2|
|---|---|
|||
|||
|||





The TIMx timers are linked together internally for timer synchronization or chaining. When
one Timer is configured in Master mode, it can reset, start, stop or clock the counter of
another Timer configured in Slave mode.


_Figure 128_ presents an overview of the trigger selection and the master mode selection
blocks.


_Note:_ _The clock of the slave timer must be enabled prior to receiving events from the master timer,_
_and must not be changed on-the-fly while triggers are received from the master timer._


**Using one timer as prescaler for another timer**


**Figure 128. Master/Slave timer example**



















316/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


For example, the user can configure TIM3 to act as a prescaler for TIM2. Refer to
_Figure 128_ . To do this:


      - Configure TIM3 in master mode so that it outputs a periodic trigger signal on each
update event UEV. If MMS=010 is written in the TIM3_CR2 register, a rising edge is
output on TRGO1 each time an update event is generated.


      - To connect the TRGO1 output of TIM3 to TIM2, TIM2 must be configured in slave mode
using ITR2 as internal trigger. Select this through the TS bits in the TIM2_SMCR
register (writing TS=010).


      - Then put the slave mode controller in external clock mode 1 (write SMS=111 in the
TIM2_SMCR register). This causes TIM2 to be clocked by the rising edge of the
periodic TIM3 trigger signal (which correspond to the TIM3 counter overflow).


      - Finally both timers must be enabled by setting their respective CEN bits (TIMx_CR1
register).


_Note:_ _If OCx is selected on TIM3 as the trigger output (MMS=1xx), its rising edge is used to clock_
_the counter of TIM2._


**Using one timer to enable another timer**


In this example, we control the enable of TIM2 with the output compare 1 of Timer 1. Refer
to _Figure 128_ for connections. TIM2 counts on the divided internal clock only when OC1REF
of TIM3 is high. Both counter clock frequencies are divided by 3 by the prescaler compared
to CK_INT (f CK_CNT = f CK_INT /3).

      - Configure TIM3 master mode to send its Output Compare 1 Reference (OC1REF)
signal as trigger output (MMS=100 in the TIM3_CR2 register).


      - Configure the TIM3 OC1REF waveform (TIM3_CCMR1 register).


      - Configure TIM2 to get the input trigger from TIM3 (TS=010 in the TIM2_SMCR
register).


      - Configure TIM2 in gated mode (SMS=101 in TIM2_SMCR register).


      - Enable TIM2 by writing ‘1 in the CEN bit (TIM2_CR1 register).


      - Start TIM3 by writing ‘1 in the CEN bit (TIM3_CR1 register).


_Note:_ _The counter 2 clock is not synchronized with counter 1, this mode only affects the TIM2_
_counter enable signal._


**Figure 129. Gating TIM2 with OC1REF of TIM3**







|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|
|---|---|---|---|---|---|---|---|---|---|---|
||||||||||||
|FC||FD||FE|FE|FF|FF||00|01|
|FC|||||||||||
|FC|||3046|3046|3047|3047|||||
|FC|||||||||||


In the example in _Figure 129_, the TIM2 counter and prescaler are not initialized before being
started. So they start counting from their current value. It is possible to start from a given


RM0041 Rev 6 317/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


value by resetting both timers before starting TIM3. The user can then write any value in the
timer counters. The timers can easily be reset by software using the UG bit in the
TIMx_EGR registers.


In the next example, we synchronize TIM3 and TIM2. TIM3 is the master and starts from 0.
TIM2 is the slave and starts from 0xE7. The prescaler ratio is the same for both timers. TIM2
stops when TIM3 is disabled by writing ‘0 to the CEN bit in the TIM3_CR1 register:


      - Configure TIM3 master mode to send its Output Compare 1 Reference (OC1REF)
signal as trigger output (MMS=100 in the TIM3_CR2 register).


      - Configure the TIM3 OC1REF waveform (TIM3_CCMR1 register).


      - Configure TIM2 to get the input trigger from TIM3 (TS=000 in the TIM2_SMCR
register).


      - Configure TIM2 in gated mode (SMS=101 in TIM2_SMCR register).


      - Reset TIM3 by writing ‘1 in UG bit (TIM3_EGR register).


      - Reset TIM2 by writing ‘1 in UG bit (TIM2_EGR register).


      - Initialize TIM2 to 0xE7 by writing ‘0xE7’ in the TIM2 counter (TIM2_CNTL).


      - Enable TIM2 by writing ‘1 in the CEN bit (TIM2_CR1 register).


      - Start TIM3 by writing ‘1 in the CEN bit (TIM3_CR1 register).


      - Stop TIM3 by writing ‘0 in the CEN bit (TIM3_CR1 register).


**Figure 130. Gating TIM2 with Enable of TIM3**












|Col1|Col2|Col3|Col4|Col5|Col6|
|---|---|---|---|---|---|
|||||||
|||||||
|||00||01||
|||||||
||00|E7||E8||
|||||||
|||||||
|||||||



**Using one timer to start another timer**


In this example, we set the enable of Timer 2 with the update event of Timer 1. Refer to
_Figure 128_ for connections. Timer 2 starts counting from its current value (which can be
non-zero) on the divided internal clock as soon as the update event is generated by Timer 1.
When Timer 2 receives the trigger signal its CEN bit is automatically set and the counter


318/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


counts until we write ‘0 to the CEN bit in the TIM2_CR1 register. Both counter clock
frequencies are divided by 3 by the prescaler compared to CK_INT (f CK_CNT = f CK_INT /3).

      - Configure TIM3 master mode to send its Update Event (UEV) as trigger output
(MMS=010 in the TIM3_CR2 register).


      - Configure the TIM3 period (TIM3_ARR registers).


      - Configure TIM2 to get the input trigger from TIM3 (TS=000 in the TIM2_SMCR
register).


      - Configure TIM2 in trigger mode (SMS=110 in TIM2_SMCR register).


      - Start TIM3 by writing ‘1 in the CEN bit (TIM3_CR1 register).


**Figure 131. Triggering TIM2 with update of TIM3**






|Col1|Col2|Col3|Col4|Col5|Col6|Col7|
|---|---|---|---|---|---|---|
|FD|FE|FF||00|01|02|



As in the previous example, both counters can be initialized before starting counting.
_Figure 132_ shows the behavior with the same configuration as in _Figure 131_ but in trigger
mode instead of gated mode (SMS=110 in the TIM2_SMCR register).


**Figure 132. Triggering TIM2 with Enable of TIM3**














|Col1|Col2|Col3|Col4|Col5|Col6|
|---|---|---|---|---|---|
|||||||
|||00||01|01|
|||||||
||00|E7||E8|E9|
|||||||
|||||||



RM0041 Rev 6 319/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


**Starting 2 timers synchronously in response to an external trigger**


In this example, we set the enable of TIM3 when its TI1 input rises, and the enable of TIM2
with the enable of TIM3. Refer to _Figure 128_ for connections. To ensure the counters are
aligned, TIM3 must be configured in Master/Slave mode (slave with respect to TI1, master
with respect to TIM2):


      - Configure TIM3 master mode to send its Enable as trigger output (MMS=001 in the
TIM3_CR2 register).


      - Configure TIM1 slave mode to get the input trigger from TI1 (TS=100 in the
TIM3_SMCR register).


      - Configure TIM3 in trigger mode (SMS=110 in the TIM3_SMCR register).


      - Configure the TIM3 in Master/Slave mode by writing MSM=1 (TIM3_SMCR register).


      - Configure TIM2 to get the input trigger from TIM3 (TS=000 in the TIM2_SMCR
register).


      - Configure TIM2 in trigger mode (SMS=110 in the TIM2_SMCR register).


When a rising edge occurs on TI1 (TIM3), both counters starts counting synchronously on
the internal clock and both TIF flags are set.


_Note:_ _In this example both timers are initialized before starting (by setting their respective UG_
_bits). Both counters starts from 0, but the user can easily insert an offset between them by_
_writing any of the counter registers (TIMx_CNT). The master/slave mode inserts a delay_
_between CNT_EN and CK_PSC on TIM3._


**Figure 133. Triggering TIM3 and TIM2 with TIM3 TI1 input**


|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|
|---|---|---|---|---|---|---|---|---|---|
|||||||||||
||01|02|03|04|05|06|07|08|09|
|||||||||||



**13.3.16** **Debug mode**







When the microcontroller enters debug mode (Cortex [®] -M3 core - halted), the TIMx counter
either continues to work normally or stops, depending on DBG_TIMx_STOP configuration
bit in DBGMCU module. For more details, refer to _Section 25.15.2: Debug support for_
_timers, watchdog and I_ _[2]_ _C_ .


320/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**

## **13.4 TIMx2 to TIM5 registers**


Refer to _Section 2.2_ for a list of abbreviations used in register descriptions.


The 32-bit peripheral registers have to be written by words (32 bits). All other peripheral
registers have to be written by half-words (16 bits) or words (32 bits). Read accesses can be
done by bytes (8 bits), half-words (16 bits) or words (32 bits).


**13.4.1** **TIMx control register 1 (TIMx_CR1)**


Address offset: 0x00


Reset value: 0x0000

|15 14 13 12 11 10|9 8|Col3|7|6 5|Col6|4|3|2|1|0|
|---|---|---|---|---|---|---|---|---|---|---|
|Reserved|CKD[1:0]|CKD[1:0]|ARPE|CMS|CMS|DIR|OPM|URS|UDIS|CEN|
|Reserved|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|



Bits 15:10 Reserved, must be kept at reset value.


Bits 9:8 **CKD** : Clock division

This bit-field indicates the division ratio between the timer clock (CK_INT) frequency and
sampling clock used by the digital filters (ETR, TIx),
00: t DTS = t CK_INT
01: t DTS = 2 × t CK_INT
10: t DTS = 4 × t CK_INT
11: Reserved


Bit 7 **ARPE** : Auto-reload preload enable

0: TIMx_ARR register is not buffered
1: TIMx_ARR register is buffered


Bits 6:5 **CMS** : Center-aligned mode selection

00: Edge-aligned mode. The counter counts up or down depending on the direction bit
(DIR).
01: Center-aligned mode 1. The counter counts up and down alternatively. Output compare
interrupt flags of channels configured in output (CCxS=00 in TIMx_CCMRx register) are set
only when the counter is counting down.
10: Center-aligned mode 2. The counter counts up and down alternatively. Output compare
interrupt flags of channels configured in output (CCxS=00 in TIMx_CCMRx register) are set
only when the counter is counting up.
11: Center-aligned mode 3. The counter counts up and down alternatively. Output compare
interrupt flags of channels configured in output (CCxS=00 in TIMx_CCMRx register) are set
both when the counter is counting up or down.

_Note: It is not allowed to switch from edge-aligned mode to center-aligned mode as long as_
_the counter is enabled (CEN=1)_


Bit 4 **DIR** : Direction

0: Counter used as upcounter
1: Counter used as downcounter

_Note: This bit is read only when the timer is configured in Center-aligned mode or Encoder_
_mode._


Bit 3 **OPM** : One-pulse mode

0: Counter is not stopped at update event
1: Counter stops counting at the next update event (clearing the bit CEN)


RM0041 Rev 6 321/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


Bit 2 **URS** : Update request source

This bit is set and cleared by software to select the UEV event sources.
0: Any of the following events generate an update interrupt or DMA request if enabled.
These events can be:

– Counter overflow/underflow

–
Setting the UG bit

–
Update generation through the slave mode controller
1: Only counter overflow/underflow generates an update interrupt or DMA request if
enabled.


Bit 1 **UDIS** : Update disable

This bit is set and cleared by software to enable/disable UEV event generation.
0: UEV enabled. The Update (UEV) event is generated by one of the following events:

– Counter overflow/underflow

–
Setting the UG bit

–
Update generation through the slave mode controller
Buffered registers are then loaded with their preload values.
1: UEV disabled. The Update event is not generated, shadow registers keep their value
(ARR, PSC, CCRx). However the counter and the prescaler are reinitialized if the UG bit is
set or if a hardware reset is received from the slave mode controller.


Bit 0 **CEN** : Counter enable

0: Counter disabled

1: Counter enabled

_Note: External clock, gated mode and encoder mode can work only if the CEN bit has been_
_previously set by software. However trigger mode can set the CEN bit automatically by_
_hardware._

CEN is cleared automatically in one-pulse mode, when an update event occurs.


322/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


**13.4.2** **TIMx control register 2 (TIMx_CR2)**


Address offset: 0x04


Reset value: 0x0000

|15 14 13 12 11 10 9 8|7|6 5 4|Col4|Col5|3|2 1 0|
|---|---|---|---|---|---|---|
|Reserved|TI1S|MMS[2:0]|MMS[2:0]|MMS[2:0]|CCDS|Reserved|
|Reserved|rw|rw|rw|rw|rw|rw|



Bits 15:8 Reserved, must be kept at reset value.


Bit 7 **TI1S** : TI1 selection

0: The TIMx_CH1 pin is connected to TI1 input
1: The TIMx_CH1, CH2 and CH3 pins are connected to the TI1 input (XOR combination)
See also _Section 12.3.18: Interfacing with Hall sensors_


Bits 6:4 **MMS[2:0]** : Master mode selection

These bits can be used to select the information to be sent in master mode to slave timers

for synchronization (TRGO). The combination is as follows:
000: **Reset**             - the UG bit from the TIMx_EGR register is used as trigger output (TRGO). If the
reset is generated by the trigger input (slave mode controller configured in reset mode) then
the signal on TRGO is delayed compared to the actual reset.
001: **Enable**             - the Counter enable signal, CNT_EN, is used as trigger output (TRGO). It is
useful to start several timers at the same time or to control a window in which a slave timer is

enabled. The Counter Enable signal is generated by a logic OR between CEN control bit
and the trigger input when configured in gated mode.
When the Counter Enable signal is controlled by the trigger input, there is a delay on TRGO,
except if the master/slave mode is selected (see the MSM bit description in TIMx_SMCR
register).
010: **Update**             - The update event is selected as trigger output (TRGO). For instance a master
timer can then be used as a prescaler for a slave timer.
011: **Compare Pulse**             - The trigger output send a positive pulse when the CC1IF flag is to be
set (even if it was already high), as soon as a capture or a compare match occurred.
(TRGO)
100: **Compare**             - OC1REF signal is used as trigger output (TRGO)
101: **Compare**             - OC2REF signal is used as trigger output (TRGO)
110: **Compare**             - OC3REF signal is used as trigger output (TRGO)
111: **Compare**             - OC4REF signal is used as trigger output (TRGO)

_Note: The clock of the slave timer and ADC must be enabled prior to receiving events from_
_the master timer, and must not be changed on-the-fly while triggers are received from_
_the master timer._


Bit 3 **CCDS** : Capture/compare DMA selection

0: CCx DMA request sent when CCx event occurs
1: CCx DMA requests sent when update event occurs


Bits 2:0 Reserved, must be kept at reset value.


RM0041 Rev 6 323/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


**13.4.3** **TIMx slave mode control register (TIMx_SMCR)**


Address offset: 0x08


Reset value: 0x0000

|15|14|13 12|Col4|11 10 9 8|Col6|Col7|Col8|7|6 5 4|Col11|Col12|3|2 1 0|Col15|Col16|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|ETP|ECE|ETPS[1:0]|ETPS[1:0]|ETF[3:0]|ETF[3:0]|ETF[3:0]|ETF[3:0]|MSM|TS[2:0]|TS[2:0]|TS[2:0]|OCCS|SMS[2:0]|SMS[2:0]|SMS[2:0]|
|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|



Bit 15 **ETP** : External trigger polarity

This bit selects whether ETR or ETR is used for trigger operations
0: ETR is non-inverted, active at high level or rising edge
1: ETR is inverted, active at low level or falling edge


Bit 14 **ECE** : External clock enable

This bit enables External clock mode 2

0: External clock mode 2 disabled

1: External clock mode 2 enabled. The counter is clocked by any active edge on the ETRF
signal.
**1:** Setting the ECE bit has the same effect as selecting external clock mode 1 with TRGI
connected to ETRF (SMS=111 and TS=111).
**2:** It is possible to simultaneously use external clock mode 2 with the following slave modes:
reset mode, gated mode and trigger mode. Nevertheless, TRGI must not be connected to
ETRF in this case (TS bits must not be 111).
**3:** If external clock mode 1 and external clock mode 2 are enabled at the same time, the
external clock input is ETRF.


Bits 13:12 **ETPS** : External trigger prescaler

External trigger signal ETRP frequency must be at most 1/4 of CK_INT frequency. A
prescaler can be enabled to reduce ETRP frequency. It is useful when inputting fast external
clocks.

00: Prescaler OFF

01: ETRP frequency divided by 2
10: ETRP frequency divided by 4
11: ETRP frequency divided by 8


Bits 11:8 **ETF[3:0]** : External trigger filter

This bit-field then defines the frequency used to sample ETRP signal and the length of the
digital filter applied to ETRP. The digital filter is made of an event counter in which N
consecutive events are needed to validate a transition on the output:
0000: No filter, sampling is done at f DTS
0001:  f SAMPLING =f CK_INT, N=2
0010:  f SAMPLING =f CK_INT, N=4
0011:  f SAMPLING =f CK_INT, N=8
0100:  f SAMPLING =f DTS /2, N=6
0101:  f SAMPLING =f DTS /2, N=8
0110:  f SAMPLING =f DTS /4, N=6
0111:  f SAMPLING =f DTS /4, N=8
1000: f SAMPLING =f DTS /8, N=6
1001: f SAMPLING =f DTS /8, N=8
1010: f SAMPLING =f DTS /16, N=5
1011: f SAMPLING =f DTS /16, N=6
1100: f SAMPLING =f DTS /16, N=8
1101: f SAMPLING =f DTS /32, N=5
1110: f SAMPLING =f DTS /32, N=6
1111: f SAMPLING =f DTS /32, N=8


324/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


Bit 7 **MSM:** Master/Slave mode

0: No action

1: The effect of an event on the trigger input (TRGI) is delayed to allow a perfect
synchronization between the current timer and its slaves (through TRGO). It is useful if we
want to synchronize several timers on a single external event.


Bits 6:4 **TS:** Trigger selection

This bit-field selects the trigger input to be used to synchronize the counter.
000: Internal Trigger 0 (ITR0).
001: Internal Trigger 1 (ITR1).
010: Internal Trigger 2 (ITR2).
011: Internal Trigger 3 (ITR3).
100: TI1 Edge Detector (TI1F_ED)
101: Filtered Timer Input 1 (TI1FP1)
110: Filtered Timer Input 2 (TI2FP2)
111: External Trigger input (ETRF)
See _Table 71: TIMx internal trigger connection on page 326_ for more details on ITRx
meaning for each Timer.

_Note: These bits must be changed only when they are not used (e.g. when SMS=000) to_
_avoid wrong edge detections at the transition._


Bit 3 **OCCS:** OCREF clear selection

This bit is used to select the OCREF clear source

0: OCREF_CLR_INT is connected to the OCREF_CLR input
1: OCREF_CLR_INT is connected to ETRF


Bits 2:0 **SMS:** Slave mode selection

When external signals are selected the active edge of the trigger signal (TRGI) is linked to
the polarity selected on the external input (see Input Control register and Control register
description.
000: Slave mode disabled - if CEN = ‘1 then the prescaler is clocked directly by the internal
clock.

001: Encoder mode 1 - Counter counts up/down on TI1FP1 edge depending on TI2FP2
level.

010: Encoder mode 2 - Counter counts up/down on TI2FP2 edge depending on TI1FP1
level.

011: Encoder mode 3 - Counter counts up/down on both TI1FP1 and TI2FP2 edges
depending on the level of the other input.
100: Reset mode - Rising edge of the selected trigger input (TRGI) reinitializes the counter
and generates an update of the registers.
101: Gated mode - The counter clock is enabled when the trigger input (TRGI) is high. The
counter stops (but is not reset) as soon as the trigger becomes low. Both start and stop of
the counter are controlled.

110: Trigger mode - The counter starts at a rising edge of the trigger TRGI (but it is not
reset). Only the start of the counter is controlled.
111: External Clock mode 1 - Rising edges of the selected trigger (TRGI) clock the counter.

_Note: The gated mode must not be used if TI1F_ED is selected as the trigger input (TS=100)._
_Indeed, TI1F_ED outputs 1 pulse for each transition on TI1F, whereas the gated mode_
_checks the level of the trigger signal._

_The clock of the slave timer must be enabled prior to receiving events from the master_
_timer, and must not be changed on-the-fly while triggers are received from the master_
_timer._


RM0041 Rev 6 325/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


**Table 71. TIMx internal trigger connection**

|Slave TIM|ITR0 (TS = 000)|ITR1 (TS = 001)|ITR2 (TS = 010)|ITR3 (TS = 011)|
|---|---|---|---|---|
|TIM2|TIM1|TIM15|TIM3|TIM4|
|TIM3|TIM1|TIM2|TIM15|TIM4|
|TIM4|TIM1|TIM2|TIM3|TIM15|



**13.4.4** **TIMx DMA/Interrupt enable register (TIMx_DIER)**


Address offset: 0x0C


Reset value: 0x0000

|15|14|13|12|11|10|9|8|7|6|5|4|3|2|1|0|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|Res.|TDE|Res|CC4DE|CC3DE|CC2DE|CC1DE|UDE|Res.|TIE|Res|CC4IE|CC3IE|CC2IE|CC1IE|UIE|
|Res.|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|



Bit 15 Reserved, must be kept at reset value.


Bit 14 **TDE** : Trigger DMA request enable

0: Trigger DMA request disabled
1: Trigger DMA request enabled


Bit 13 Reserved, must be kept at reset value.


Bit 12 **CC4DE** : Capture/Compare 4 DMA request enable

0: CC4 DMA request disabled
1: CC4 DMA request enabled


Bit 11 **CC3DE** : Capture/Compare 3 DMA request enable

0: CC3 DMA request disabled
1: CC3 DMA request enabled


Bit 10 **CC2DE** : Capture/Compare 2 DMA request enable

0: CC2 DMA request disabled
1: CC2 DMA request enabled


Bit 9 **CC1DE** : Capture/Compare 1 DMA request enable

0: CC1 DMA request disabled
1: CC1 DMA request enabled


Bit 8 **UDE** : Update DMA request enable

0: Update DMA request disabled
1: Update DMA request enabled


Bit 7 Reserved, must be kept at reset value.


Bit 6 **TIE** : Trigger interrupt enable

0: Trigger interrupt disabled
1: Trigger interrupt enabled


Bit 5 Reserved, must be kept at reset value.


Bit 4 **CC4IE** : Capture/Compare 4 interrupt enable

0: CC4 interrupt disabled
1: CC4 interrupt enabled


326/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


Bit 3 **CC3IE** : Capture/Compare 3 interrupt enable

0: CC3 interrupt disabled
1: CC3 interrupt enabled


Bit 2 **CC2IE** : Capture/Compare 2 interrupt enable

0: CC2 interrupt disabled
1: CC2 interrupt enabled


Bit 1 **CC1IE** : Capture/Compare 1 interrupt enable

0: CC1 interrupt disabled
1: CC1 interrupt enabled


Bit 0 **UIE** : Update interrupt enable

0: Update interrupt disabled
1: Update interrupt enabled


**13.4.5** **TIMx status register (TIMx_SR)**


Address offset: 0x10


Reset value: 0x0000

|15 14 13|12|11|10|9|8 7|6|5|4|3|2|1|0|
|---|---|---|---|---|---|---|---|---|---|---|---|---|
|Reserved|CC4OF|CC3OF|CC2OF|CC1OF|Reserved|TIF|Res|CC4IF|CC3IF|CC2IF|CC1IF|UIF|
|Reserved|rc_w0|rc_w0|rc_w0|rc_w0|rc_w0|rc_w0|rc_w0|rc_w0|rc_w0|rc_w0|rc_w0|rc_w0|



Bits 15:13 Reserved, must be kept at reset value.


Bit 12 **CC4OF** : Capture/Compare 4 overcapture flag

refer to CC1OF description


Bit 11 **CC3OF** : Capture/Compare 3 overcapture flag

refer to CC1OF description


Bit 10 **CC2OF** : Capture/compare 2 overcapture flag

refer to CC1OF description


Bit 9 **CC1OF** : Capture/Compare 1 overcapture flag

This flag is set by hardware only when the corresponding channel is configured in input
capture mode. It is cleared by software by writing it to ‘0.
0: No overcapture has been detected
1: The counter value has been captured in TIMx_CCR1 register while CC1IF flag was
already set


Bits 8:7 Reserved, must be kept at reset value.


Bit 6 **TIF** : Trigger interrupt flag

This flag is set by hardware on trigger event (active edge detected on TRGI input when the
slave mode controller is enabled in all modes but gated mode. It is set when the counter
starts or stops when gated mode is selected. It is cleared by software.
0: No trigger event occurred
1: Trigger interrupt pending


Bit 5 Reserved, must be kept at reset value.


Bit 4 **CC4IF** : Capture/Compare 4 interrupt flag

refer to CC1IF description


RM0041 Rev 6 327/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


Bit 3 **CC3IF** : Capture/Compare 3 interrupt flag

refer to CC1IF description


Bit 2 **CC2IF** : Capture/Compare 2 interrupt flag

refer to CC1IF description


Bit 1 **CC1IF** : Capture/compare 1 interrupt flag

**If channel CC1 is configured as output:**
This flag is set by hardware when the counter matches the compare value, with some
exception in center-aligned mode (refer to the CMS bits in the TIMx_CR1 register
description). It is cleared by software.
0: No match

1: The content of the counter TIMx_CNT matches the content of the TIMx_CCR1 register.
When the contents of TIMx_CCR1 are greater than the contents of TIMx_ARR, the CC1IF bit
goes high on the counter overflow (in upcounting and up/down-counting modes) or underflow
(in downcounting mode)
**If channel CC1 is configured as input:**
This bit is set by hardware on a capture. It is cleared by software or by reading the
TIMx_CCR1 register.
0: No input capture occurred
1: The counter value has been captured in TIMx_CCR1 register (An edge has been detected
on IC1 which matches the selected polarity)


Bit 0 **UIF** : Update interrupt flag

This bit is set by hardware on an update event. It is cleared by software.
0: No update occurred
1: Update interrupt pending. This bit is set by hardware when the registers are updated:
At overflow or underflow (for TIM2 to TIM4) and if UDIS=0 in the TIMx_CR1 register.
When CNT is reinitialized by software using the UG bit in TIMx_EGR register, if URS=0 and
UDIS=0 in the TIMx_CR1 register.
When CNT is reinitialized by a trigger event (refer to the synchro control register description),
if URS=0 and UDIS=0 in the TIMx_CR1 register.


328/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


**13.4.6** **TIMx event generation register (TIMx_EGR)**


Address offset: 0x14


Reset value: 0x0000

|15 14 13 12 11 10 9 8 7|6|5|4|3|2|1|0|
|---|---|---|---|---|---|---|---|
|Reserved|TG|Res.|CC4G|CC3G|CC2G|CC1G|UG|
|Reserved|w|w|w|w|w|w|w|



Bits 15:7 Reserved, must be kept at reset value.


Bit 6 **TG** : Trigger generation

This bit is set by software in order to generate an event, it is automatically cleared by
hardware.

0: No action

1: The TIF flag is set in TIMx_SR register. Related interrupt or DMA transfer can occur if
enabled.


Bit 5 Reserved, must be kept at reset value.


Bit 4 **CC4G** : Capture/compare 4 generation

refer to CC1G description


Bit 3 **CC3G** : Capture/compare 3 generation

refer to CC1G description


Bit 2 **CC2G** : Capture/compare 2 generation

refer to CC1G description


Bit 1 **CC1G** : Capture/compare 1 generation

This bit is set by software in order to generate an event, it is automatically cleared by
hardware.

0: No action

1: A capture/compare event is generated on channel 1:
**If channel CC1 is configured as output:**
CC1IF flag is set, Corresponding interrupt or DMA request is sent if enabled.
**If channel CC1 is configured as input:**
The current value of the counter is captured in TIMx_CCR1 register. The CC1IF flag is set,
the corresponding interrupt or DMA request is sent if enabled. The CC1OF flag is set if the
CC1IF flag was already high.


Bit 0 **UG** : Update generation

This bit can be set by software, it is automatically cleared by hardware.
0: No action

1: Re-initialize the counter and generates an update of the registers. Note that the prescaler
counter is cleared too (anyway the prescaler ratio is not affected). The counter is cleared if
the center-aligned mode is selected or if DIR=0 (upcounting), else it takes the auto-reload
value (TIMx_ARR) if DIR=1 (downcounting).


RM0041 Rev 6 329/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


**13.4.7** **TIMx capture/compare mode register 1 (TIMx_CCMR1)**


Address offset: 0x18


Reset value: 0x0000


The channels can be used in input (capture mode) or in output (compare mode). The
direction of a channel is defined by configuring the corresponding CCxS bits. All the other
bits of this register have a different function in input and in output mode. For a given bit,
OCxx describes its function when the channel is configured in output, ICxx describes its
function when the channel is configured in input. Take care that the same bit can have a
different meaning for the input stage and for the output stage.

|15|14 13 12|Col3|Col4|11|10|9 8|Col8|7|6 5 4|Col11|Col12|3|2|1 0|Col16|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|OC2CE|OC2M[2:0]|OC2M[2:0]|OC2M[2:0]|OC2PE|OC2FE|CC2S[1:0]|CC2S[1:0]|OC1CE|OC1M[2:0]|OC1M[2:0]|OC1M[2:0]|OC1PE|OC1FE|CC1S[1:0]|CC1S[1:0]|
|IC2F[3:0]|IC2F[3:0]|IC2F[3:0]|IC2F[3:0]|IC2PSC[1:0]|IC2PSC[1:0]|IC2PSC[1:0]|IC2PSC[1:0]|IC1F[3:0]|IC1F[3:0]|IC1F[3:0]|IC1F[3:0]|IC1PSC[1:0]|IC1PSC[1:0]|IC1PSC[1:0]|IC1PSC[1:0]|
|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|



**Output compare mode**


Bit 15 **OC2CE:** Output compare 2 clear enable


Bits 14:12 **OC2M[2:0]** : Output compare 2 mode


Bit 11 **OC2PE** : Output compare 2 preload enable


Bit 10 **OC2FE** : Output compare 2 fast enable


Bits 9:8 **CC2S[1:0]** : Capture/Compare 2 selection

This bit-field defines the direction of the channel (input/output) as well as the used input.
00: CC2 channel is configured as output
01: CC2 channel is configured as input, IC2 is mapped on TI2
10: CC2 channel is configured as input, IC2 is mapped on TI1
11: CC2 channel is configured as input, IC2 is mapped on TRC. This mode is working only if
an internal trigger input is selected through the TS bit (TIMx_SMCR register)

_Note: CC2S bits are writable only when the channel is OFF (CC2E = 0 in TIMx_CCER)._


Bit 7 **OC1CE:** Output compare 1 clear enable

OC1CE: Output compare 1 Clear Enable
0: OC1Ref is not affected by the ETRF input
1: OC1Ref is cleared as soon as a High level is detected on ETRF input


330/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


Bits 6:4 **OC1M** : Output compare 1 mode

These bits define the behavior of the output reference signal OC1REF from which OC1 and
OC1N are derived. OC1REF is active high whereas OC1 and OC1N active level depends
on CC1P and CC1NP bits.

000: Frozen - The comparison between the output compare register TIMx_CCR1 and the
counter TIMx_CNT has no effect on the outputs.(this mode is used to generate a timing
base).
001: Set channel 1 to active level on match. OC1REF signal is forced high when the counter
TIMx_CNT matches the capture/compare register 1 (TIMx_CCR1).
010: Set channel 1 to inactive level on match. OC1REF signal is forced low when the
counter TIMx_CNT matches the capture/compare register 1 (TIMx_CCR1).
011: Toggle - OC1REF toggles when TIMx_CNT=TIMx_CCR1.
100: Force inactive level - OC1REF is forced low.

101: Force active level - OC1REF is forced high.
110: PWM mode 1 - In upcounting, channel 1 is active as long as TIMx_CNT<TIMx_CCR1
else inactive. In downcounting, channel 1 is inactive (OC1REF=‘0) as long as
TIMx_CNT>TIMx_CCR1 else active (OC1REF=1).
111: PWM mode 2 - In upcounting, channel 1 is inactive as long as TIMx_CNT<TIMx_CCR1
else active. In downcounting, channel 1 is active as long as TIMx_CNT>TIMx_CCR1 else
inactive.

_Note: In PWM mode 1 or 2, the OCREF level changes only when the result of the_
_comparison changes or when the output compare mode switches from “frozen” mode_
_to “PWM” mode._


Bit 3 **OC1PE** : Output compare 1 preload enable

0: Preload register on TIMx_CCR1 disabled. TIMx_CCR1 can be written at anytime, the
new value is taken in account immediately.
1: Preload register on TIMx_CCR1 enabled. Read/Write operations access the preload
register. TIMx_CCR1 preload value is loaded in the active register at each update event.

_Note: These bits can not be modified as long as LOCK level 3 has been programmed (LOCK_
_bits in TIMx_BDTR register) and CC1S=00 (the channel is configured in output)._


Bit 2 **OC1FE** : Output compare 1 fast enable

This bit is used to accelerate the effect of an event on the trigger in input on the CC output.
0: CC1 behaves normally depending on counter and CCR1 values even when the trigger is
ON. The minimum delay to activate CC1 output when an edge occurs on the trigger input is
5 clock cycles.
1: An active edge on the trigger input acts like a compare match on CC1 output. Then, OC
is set to the compare level independently from the result of the comparison. Delay to sample
the trigger input and to activate CC1 output is reduced to 3 clock cycles. OCFE acts only if
the channel is configured in PWM1 or PWM2 mode.


Bits 1:0 **CC1S** : Capture/Compare 1 selection

This bit-field defines the direction of the channel (input/output) as well as the used input.
00: CC1 channel is configured as output.
01: CC1 channel is configured as input, IC1 is mapped on TI1.
10: CC1 channel is configured as input, IC1 is mapped on TI2.
11: CC1 channel is configured as input, IC1 is mapped on TRC. This mode is working only if
an internal trigger input is selected through TS bit (TIMx_SMCR register)

_Note: CC1S bits are writable only when the channel is OFF (CC1E = 0 in TIMx_CCER)._


RM0041 Rev 6 331/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


**Input capture mode**


Bits 15:12 **IC2F** : Input capture 2 filter


Bits 11:10 **IC2PSC[1:0]** : Input capture 2 prescaler


Bits 9:8 **CC2S** : Capture/compare 2 selection

This bit-field defines the direction of the channel (input/output) as well as the used input.
00: CC2 channel is configured as output.
01: CC2 channel is configured as input, IC2 is mapped on TI2.
10: CC2 channel is configured as input, IC2 is mapped on TI1.
11: CC2 channel is configured as input, IC2 is mapped on TRC. This mode is working only if
an internal trigger input is selected through TS bit (TIMx_SMCR register)

_Note: CC2S bits are writable only when the channel is OFF (CC2E = 0 in TIMx_CCER)._


Bits 7:4 **IC1F** : Input capture 1 filter

This bit-field defines the frequency used to sample TI1 input and the length of the digital filter
applied to TI1. The digital filter is made of an event counter in which N consecutive events
are needed to validate a transition on the output:
0000: No filter, sampling is done at f DTS
0001: f SAMPLING =f CK_INT, N=2
0010: f SAMPLING =f CK_INT, N=4
0011: f SAMPLING =f CK_INT, N=8
0100: f SAMPLING =f DTS /2, N=6
0101: f SAMPLING =f DTS /2, N=8
0110: f SAMPLING =f DTS /4, N=6
0111: f SAMPLING =f DTS /4, N=8
1000: f SAMPLING =f DTS /8, N=6
1001: f SAMPLING =f DTS /8, N=8
1010: f SAMPLING =f DTS /16, N=5
1011: f SAMPLING =f DTS /16, N=6
1100: f SAMPLING =f DTS /16, N=8
1101: f SAMPLING =f DTS /32, N=5
1110: f SAMPLING =f DTS /32, N=6
1111: f SAMPLING =f DTS /32, N=8


Bits 3:2 **IC1PSC** : Input capture 1 prescaler

This bit-field defines the ratio of the prescaler acting on CC1 input (IC1).
The prescaler is reset as soon as CC1E=0 (TIMx_CCER register).
00: no prescaler, capture is done each time an edge is detected on the capture input
01: capture is done once every 2 events
10: capture is done once every 4 events
11: capture is done once every 8 events


Bits 1:0 **CC1S** : Capture/Compare 1 selection

This bit-field defines the direction of the channel (input/output) as well as the used input.
00: CC1 channel is configured as output
01: CC1 channel is configured as input, IC1 is mapped on TI1
10: CC1 channel is configured as input, IC1 is mapped on TI2
11: CC1 channel is configured as input, IC1 is mapped on TRC. This mode is working only if
an internal trigger input is selected through TS bit (TIMx_SMCR register)

_Note: CC1S bits are writable only when the channel is OFF (CC1E = 0 in TIMx_CCER)._


332/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


**13.4.8** **TIMx capture/compare mode register 2 (TIMx_CCMR2)**


Address offset: 0x1C


Reset value: 0x0000


Refer to the above CCMR1 register description.

|15|14 13 12|Col3|Col4|11|10|9 8|Col8|7|6 5 4|Col11|Col12|3|2|1 0|Col16|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|OC4CE|OC4M[2:0]|OC4M[2:0]|OC4M[2:0]|OC4PE|OC4FE|CC4S[1:0]|CC4S[1:0]|OC3CE|OC3M[2:0]|OC3M[2:0]|OC3M[2:0]|OC3PE|OC3FE|CC3S[1:0]|CC3S[1:0]|
|IC4F[3:0]|IC4F[3:0]|IC4F[3:0]|IC4F[3:0]|IC4PSC[1:0]|IC4PSC[1:0]|IC4PSC[1:0]|IC4PSC[1:0]|IC3F[3:0]|IC3F[3:0]|IC3F[3:0]|IC3F[3:0]|IC3PSC[1:0]|IC3PSC[1:0]|IC3PSC[1:0]|IC3PSC[1:0]|
|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|



**Output compare mode**


Bit 15 **OC4CE** : Output compare 4 clear enable


Bits 14:12 **OC4M** : Output compare 4 mode


Bit 11 **OC4PE** : Output compare 4 preload enable


Bit 10 **OC4FE** : Output compare 4 fast enable


Bits 9:8 **CC4S** : Capture/Compare 4 selection

This bit-field defines the direction of the channel (input/output) as well as the used input.
00: CC4 channel is configured as output
01: CC4 channel is configured as input, IC4 is mapped on TI4
10: CC4 channel is configured as input, IC4 is mapped on TI3
11: CC4 channel is configured as input, IC4 is mapped on TRC. This mode is working only if
an internal trigger input is selected through TS bit (TIMx_SMCR register)

_Note: CC4S bits are writable only when the channel is OFF (CC4E = 0 in TIMx_CCER)._


Bit 7 **OC3CE:** Output compare 3 clear enable


Bits 6:4 **OC3M** : Output compare 3 mode


Bit 3 **OC3PE** : Output compare 3 preload enable


Bit 2 **OC3FE** : Output compare 3 fast enable


Bits 1:0 **CC3S** : Capture/Compare 3 selection

This bit-field defines the direction of the channel (input/output) as well as the used input.
00: CC3 channel is configured as output
01: CC3 channel is configured as input, IC3 is mapped on TI3
10: CC3 channel is configured as input, IC3 is mapped on TI4
11: CC3 channel is configured as input, IC3 is mapped on TRC. This mode is working only if
an internal trigger input is selected through TS bit (TIMx_SMCR register)

_Note: CC3S bits are writable only when the channel is OFF (CC3E = 0 in TIMx_CCER)._


RM0041 Rev 6 333/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


**Input capture mode**


Bits 15:12 **IC4F** : Input capture 4 filter


Bits 11:10 **IC4PSC** : Input capture 4 prescaler


Bits 9:8 **CC4S** : Capture/Compare 4 selection

This bit-field defines the direction of the channel (input/output) as well as the used input.
00: CC4 channel is configured as output
01: CC4 channel is configured as input, IC4 is mapped on TI4
10: CC4 channel is configured as input, IC4 is mapped on TI3
11: CC4 channel is configured as input, IC4 is mapped on TRC. This mode is working only if
an internal trigger input is selected through TS bit (TIMx_SMCR register)

_Note: CC4S bits are writable only when the channel is OFF (CC4E = 0 in TIMx_CCER)._


Bits 7:4 **IC3F** : Input capture 3 filter


Bits 3:2 **IC3PSC** : Input capture 3 prescaler


Bits 1:0 **CC3S** : Capture/Compare 3 selection

This bit-field defines the direction of the channel (input/output) as well as the used input.
00: CC3 channel is configured as output
01: CC3 channel is configured as input, IC3 is mapped on TI3
10: CC3 channel is configured as input, IC3 is mapped on TI4
11: CC3 channel is configured as input, IC3 is mapped on TRC. This mode is working only if
an internal trigger input is selected through TS bit (TIMx_SMCR register)

_Note: CC3S bits are writable only when the channel is OFF (CC3E = 0 in TIMx_CCER)._


**13.4.9** **TIMx capture/compare enable register (TIMx_CCER)**


Address offset: 0x20


Reset value: 0x0000

|15 14|13|12|11 10|9|8|7 6|5|4|3 2|1|0|
|---|---|---|---|---|---|---|---|---|---|---|---|
|Reserved|CC4P|CC4E|Reserved|CC3P|CC3E|Reserved|CC2P|CC2E|Reserved|CC1P|CC1E|
|Reserved|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|



Bits 15:14 Reserved, must be kept at reset value.


Bit 13 **CC4P** : Capture/Compare 4 output polarity

refer to CC1P description


Bit 12 **CC4E** : Capture/Compare 4 output enable

refer to CC1E description


Bits 11:10 Reserved, must be kept at reset value.


Bit 9 **CC3P** : Capture/Compare 3 output polarity

refer to CC1P description


Bit 8 **CC3E** : Capture/Compare 3 output enable

refer to CC1E description


Bits 7:6 Reserved, must be kept at reset value.


Bit 5 **CC2P** : Capture/Compare 2 output polarity

refer to CC1P description


334/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


Bit 4 **CC2E** : Capture/Compare 2 output enable

refer to CC1E description


Bits 3:2 Reserved, must be kept at reset value.


Bit 1 **CC1P** : Capture/Compare 1 output polarity

**CC1 channel configured as output:**
0: OC1 active high.
1: OC1 active low.

**CC1 channel configured as input:**
This bit selects whether IC1 or IC1 is used for trigger or capture operations.
0: non-inverted: capture is done on a rising edge of IC1. When used as external trigger, IC1
is non-inverted.

1: inverted: capture is done on a falling edge of IC1. When used as external trigger, IC1 is
inverted.


Bit 0 **CC1E** : Capture/Compare 1 output enable

**CC1 channel configured as output:**
0: Off - OC1 is not active.

1: On - OC1 signal is output on the corresponding output pin.
**CC1 channel configured as input:**
This bit determines if a capture of the counter value can actually be done into the input
capture/compare register 1 (TIMx_CCR1) or not.
0: Capture disabled.
1: Capture enabled.


**Table 72. Output control bit for standard OCx channels**

|CCxE bit|OCx output state|
|---|---|
|0|Output Disabled (OCx=0, OCx_EN=0)|
|1|OCx=OCxREF + Polarity, OCx_EN=1|



_Note:_ _The state of the external IO pins connected to the standard OCx channels depends on the_
_OCx channel state and the GPIO and AFIO registers._


**13.4.10** **TIMx counter (TIMx_CNT)**


Address offset: 0x24


Reset value: 0x0000 0000

|15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|
|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|



Bits 15:0 **CNT[15:0]** : Counter value


**13.4.11** **TIMx prescaler (TIMx_PSC)**


Address offset: 0x28


RM0041 Rev 6 335/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


Reset value: 0x0000

|15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|
|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|



Bits 15:0 **PSC[15:0]** : Prescaler value
The counter clock frequency CK_CNT is equal to f CK_PSC / (PSC[15:0] + 1).
PSC contains the value to be loaded in the active prescaler register at each update event
(including when the counter is cleared through UG bit of TIMx_EGR register or through
trigger controller when configured in “reset mode”).


**13.4.12** **TIMx auto-reload register (TIMx_ARR)**


Address offset: 0x2C


Reset value: 0xFFFF

|15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|
|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|



Bits 15:0 **ARR[15:0]** : Low Auto-reload value
ARR is the value to be loaded in the actual auto-reload register.
Refer to the _Section 13.3.1: Time-base unit_ for more details about ARR update and
behavior.

The counter is blocked while the auto-reload value is null.


**13.4.13** **TIMx capture/compare register 1 (TIMx_CCR1)**


Address offset: 0x34


Reset value: 0x0000

|15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|
|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|



Bits 15:0 **CCR1[15:0]** : Capture/Compare 1 value

**If channel CC1 is configured as output** :
CCR1 is the value to be loaded in the actual capture/compare 1 register (preload value).
It is loaded permanently if the preload feature is not selected in the TIMx_CCMR1 register
(bit OC1PE). Else the preload value is copied in the active capture/compare 1 register when
an update event occurs.
The active capture/compare register contains the value to be compared to the counter
TIMx_CNT and signaled on OC1 output.


**If channel CC1is configured as input** :
CCR1 is the counter value transferred by the last input capture 1 event (IC1). The
TIMx_CCR1 register is read-only and cannot be programmed.


336/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


**13.4.14** **TIMx capture/compare register 2 (TIMx_CCR2)**


Address offset: 0x38


Reset value: 0x0000

|15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|
|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|



Bits 15:0 **CCR2[15:0]** : Capture/Compare 2 value

**If channel CC2 is configured as output:**
CCR2 is the value to be loaded in the actual capture/compare 2 register (preload value).
It is loaded permanently if the preload feature is not selected in the TIMx_CCMR2 register
(bit OC2PE). Else the preload value is copied in the active capture/compare 2 register when
an update event occurs.
The active capture/compare register contains the value to be compared to the counter
TIMx_CNT and signalled on OC2 output.
**If channel CC2 is configured as input:**
CCR2 is the counter value transferred by the last input capture 2 event (IC2). The
TIMx_CCR2 register is read-only and cannot be programmed.


**13.4.15** **TIMx capture/compare register 3 (TIMx_CCR3)**


Address offset: 0x3C


Reset value: 0x0000

|15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|
|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|



Bits 15:0 **CCR3[15:0]** : Capture/Compare value

**If channel CC3 is configured as output:**
CCR3 is the value to be loaded in the actual capture/compare 3 register (preload value).
It is loaded permanently if the preload feature is not selected in the TIMx_CCMR3 register
(bit OC3PE). Else the preload value is copied in the active capture/compare 3 register when
an update event occurs.
The active capture/compare register contains the value to be compared to the counter
TIMx_CNT and signaled on OC3 output.
**If channel CC3 is configured as input:**
CCR3 is the counter value transferred by the last input capture 3 event (IC3). The
TIMx_CCR3 register is read-only and cannot be programmed.


**13.4.16** **TIMx capture/compare register 4 (TIMx_CCR4)**


Address offset: 0x40


Reset value: 0x0000

|15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|
|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|rw/ro|



RM0041 Rev 6 337/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


Bits 15:0 **CCR4[15:0]** : Capture/Compare value

1. if CC4 channel is configured as output (CC4S bits):
CCR4 is the value to be loaded in the actual capture/compare 4 register (preload value).
It is loaded permanently if the preload feature is not selected in the TIMx_CCMR4
register (bit OC4PE). Else the preload value is copied in the active capture/compare 4
register when an update event occurs.
The active capture/compare register contains the value to be compared to the counter
TIMx_CNT and signalled on OC4 output.

2. if CC4 channel is configured as input (CC4S bits in TIMx_CCMR4 register):
CCR4 is the counter value transferred by the last input capture 4 event (IC4). The
TIMx_CCR4 register is read-only and cannot be programmed.


**13.4.17** **TIMx DMA control register (TIMx_DCR)**


Address offset: 0x48


Reset value: 0x0000

|15 14 13|12 11 10 9 8|Col3|Col4|Col5|Col6|7 6 5|4 3 2 1 0|Col9|Col10|Col11|Col12|
|---|---|---|---|---|---|---|---|---|---|---|---|
|Reserved|DBL[4:0]|DBL[4:0]|DBL[4:0]|DBL[4:0]|DBL[4:0]|Reserved|DBA[4:0]|DBA[4:0]|DBA[4:0]|DBA[4:0]|DBA[4:0]|
|Reserved|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|



Bits 15:13 Reserved, must be kept at reset value.


Bits 12:8 **DBL[4:0]** : DMA burst length

This 5-bit vector defines the number of DMA transfers (the timer recognizes a burst transfer
when a read or a write access is done to the TIMx_DMAR address).
00000: 1 transfer,
00001: 2 transfers,
00010: 3 transfers,

...

10001: 18 transfers.


Bits 7:5 Reserved, must be kept at reset value.


Bits 4:0 **DBA[4:0]** : DMA base address

This 5-bit vector defines the base-address for DMA transfers (when read/write access are
done through the TIMx_DMAR address). DBA is defined as an offset starting from the
address of the TIMx_CR1 register.
Example:
00000: TIMx_CR1,
00001: TIMx_CR2,
00010: TIMx_SMCR,

...

**Example:** Let us consider the following transfer: DBL = 7 transfers & DBA = TIMx_CR1. In this
case the transfer is done to/from 7 registers starting from the TIMx_CR1 address.


**13.4.18** **TIMx DMA address for full transfer (TIMx_DMAR)**


Address offset: 0x4C


Reset value: 0x0000

|15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|
|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|



338/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


Bits 15:0 **DMAB[15:0]** : DMA register for burst accesses

A read or write operation to the DMAR register accesses the register located at the address

(TIMx_CR1 address) + (DBA + DMA index) x 4

where TIMx_CR1 address is the address of the control register 1, DBA is the DMA base
address configured in TIMx_DCR register, DMA index is automatically controlled by the
DMA transfer, and ranges from 0 to DBL (DBL configured in TIMx_DCR).


**Example of how to use the DMA burst feature**


In this example the timer DMA burst feature is used to update the contents of the CCRx
registers (x = 2, 3, 4) with the DMA transferring half words into the CCRx registers.


This is done in the following steps:


1. Configure the corresponding DMA channel as follows:


–
DMA channel peripheral address is the DMAR register address


–
DMA channel memory address is the address of the buffer in the RAM containing
the data to be transferred by DMA into CCRx registers.


–
Number of data to transfer = 3 (See note below).


– Circular mode disabled.


2. Configure the DCR register by configuring the DBA and DBL bit fields as follows:
DBL = 3 transfers, DBA = 0xE.


3. Enable the TIMx update DMA request (set the UDE bit in the DIER register).


4. Enable TIMx


5. Enable the DMA channel


_Note:_ _This example is for the case where every CCRx register to be updated once. If every CCRx_
_register is to be updated twice for example, the number of data to transfer should be 6. Let's_
_take the example of a buffer in the RAM containing data1, data2, data3, data4, data5 and_
_data6. The data is transferred to the CCRx registers as follows: on the first update DMA_
_request, data1 is transferred to CCR2, data2 is transferred to CCR3, data3 is transferred to_
_CCR4 and on the second update DMA request, data4 is transferred to CCR2, data5 is_
_transferred to CCR3 and data6 is transferred to CCR4._


RM0041 Rev 6 339/709



341


**General-purpose timers (TIM2 to TIM5)** **RM0041**


**13.4.19** **TIMx register map**


TIMx registers are mapped as described in the table below:


**Table 73. TIMx register map and reset values**

































































































|Offset|Register|31|30|29|28|27|26|25|24|23|22|21|20|19|18|17|16|15|14|13|12|11|10|9|8|7|6|5|4|3|2|1|0|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|0x00|TIMx_CR1|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|CKD<br>[1:0]|CKD<br>[1:0]|ARPE|CMS<br>[1:0]|CMS<br>[1:0]|DIR|OPM|URS|UDIS|CEN|
|0x00|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|0|0|0|0|0|0|0|0|0|0|
|0x04|TIMx_CR2|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|TI1S|MMS<br>[2:0]|MMS<br>[2:0]|MMS<br>[2:0]|CCDS|Reserved|Reserved|Reserved|
|0x04|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|0|0|0|0|0|0|0|0|
|0x08|TIMx_SMCR|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|ETP|ECE|ETPS<br>[1:0]|ETPS<br>[1:0]|ETF[3:0]|ETF[3:0]|ETF[3:0]|ETF[3:0]|MSM|TS[2:0]|TS[2:0]|TS[2:0]|Reserved|SMS[2:0]|SMS[2:0]|SMS[2:0]|
|0x08|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|
|0x0C|TIMx_DIER|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|TDE|COMDE|CC4DE|CC3DE|CC2DE|CC1DE|UDE|Reserved|TIE|Reserved|CC4IE|CC3IE|CC2IE|CC1IE|UIE|
|0x0C|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|
|0x10|TIMx_SR|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|CC4OF|CC3OF|CC2OF|CC1OF|Reserved|Reserved|TIF|Reserved|CC4IF|CC3IF|CC2IF|CC1IF|UIF|
|0x10|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|0|0|0|0|0|0|0|0|0|0|0|0|0|
|0x14|TIMx_EGR|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|TG|Reserved|CC4G|CC3G|CC2G|CC1G|UG|
|0x14|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|0|0|0|0|0|0|0|
|0x18|TIMx_CCMR1<br>Output<br>compare<br>mode|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|OC2CE|OC2M<br>[2:0]|OC2M<br>[2:0]|OC2M<br>[2:0]|OC2PE|OC2FE|CC2S<br>[1:0]|CC2S<br>[1:0]|OC1CE|OC1M<br>[2:0]|OC1M<br>[2:0]|OC1M<br>[2:0]|OC1PE|OC1FE|CC1S<br>[1:0]|CC1S<br>[1:0]|
|0x18|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|
|0x18|TIMx_CCMR1<br>Input capture<br>mode|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|IC2F[3:0]|IC2F[3:0]|IC2F[3:0]|IC2F[3:0]|IC2<br>PSC<br>[1:0]|IC2<br>PSC<br>[1:0]|CC2S<br>[1:0]|CC2S<br>[1:0]|IC1F[3:0]|IC1F[3:0]|IC1F[3:0]|IC1F[3:0]|IC1<br>PSC<br>[1:0]|IC1<br>PSC<br>[1:0]|CC1S<br>[1:0]|CC1S<br>[1:0]|
|0x18|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|
|0x1C|TIMx_CCMR2<br>Output<br>compare<br>mode|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|OC4CE|OC4M<br>[2:0]|OC4M<br>[2:0]|OC4M<br>[2:0]|OC4PE|OC4FE|CC4S<br>[1:0]|CC4S<br>[1:0]|OC3CE|OC3M<br>[2:0]|OC3M<br>[2:0]|OC3M<br>[2:0]|OC3PE|OC3FE|CC3S<br>[1:0]|CC3S<br>[1:0]|
|0x1C|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|
|0x1C|TIMx_CCMR2<br>Input capture<br>mode|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|IC4F[3:0]|IC4F[3:0]|IC4F[3:0]|IC4F[3:0]|IC4<br>PSC<br>[1:0]|IC4<br>PSC<br>[1:0]|CC4S<br>[1:0]|CC4S<br>[1:0]|IC3F[3:0]|IC3F[3:0]|IC3F[3:0]|IC3F[3:0]|IC3<br>PSC<br>[1:0]|IC3<br>PSC<br>[1:0]|CC3S<br>[1:0]|CC3S<br>[1:0]|
|0x1C|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|
|0x20|TIMx_CCER|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|CC4P|CC4E|Reserved|Reserved|CC3P|CC3E|Reserved|Reserved|CC2P|CC2E|Reserved|Reserved|CC1P|CC1E|
|0x20|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|0|0|0|0|0|0|0|0|0|0|0|0|0|0|


340/709 RM0041 Rev 6


**RM0041** **General-purpose timers (TIM2 to TIM5)**


**Table 73. TIMx register map and reset values (continued)**

























































|Offset|Register|31|30|29|28|27|26|25|24|23|22|21|20|19|18|17|16|15|14|13|12|11|10|9|8|7|6|5|4|3|2|1|0|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|0x24|TIMx_CNT|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|
|0x24|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|
|0x28|TIMx_PSC|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|
|0x28|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|
|0x2C|TIMx_ARR|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|
|0x2C|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|1|1|1|1|1|1|1|1|1|1|1|1|1|1|1|1|
|0x30|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|
|0x34|TIMx_CCR1|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|CCR1[15:0]|
|0x34|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|
|0x38|TIMx_CCR2|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|CCR2[15:0]|
|0x38|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|
|0x3C|TIMx_CCR3|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|CCR3[15:0]|
|0x3C|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|
|0x40|TIMx_CCR4|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|CCR4[15:0]|
|0x40|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|
|0x44|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|
|0x48|TIMx_DCR|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|DBL[4:0]|DBL[4:0]|DBL[4:0]|DBL[4:0]|DBL[4:0]|Reserved|Reserved|Reserved|DBA[4:0]|DBA[4:0]|DBA[4:0]|DBA[4:0]|DBA[4:0]|
|0x48|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|0|0|0|0|0|0|0|0|0|0|0|0|0|
|0x4C|TIMx_DMAR|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|Reserved|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|DMAB[15:0]|
|0x4C|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|Reset value|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|


Refer to for the register boundary addresses.


RM0041 Rev 6 341/709



341


