**RM0360** **Basic timer (TIM6/TIM7)**

# **15 Basic timer (TIM6/TIM7)**


This section applies to STM32F030x8, STM32F070xB and STM32F030xC devices only.
TIM7 is available only on STM32F070xB and STM32F030xC devices.

# **15.1 TIM6/TIM7 introduction**


The basic timer TIM6 consists of a 16-bit auto-reload counter driven by a programmable
prescaler.

# **15.2 TIM6/TIM7 main features**


      - 16-bit auto-reload upcounter


      - 16-bit programmable prescaler used to divide (also “on the fly”) the counter clock
frequency by any factor between 1 and 65535


      - Interrupt/DMA generation on the update event: counter overflow


**Figure 139. Basic timer block diagram**















RM0360 Rev 5 367/775



379


**Basic timer (TIM6/TIM7)** **RM0360**

# **15.3 TIM6/TIM7 functional description**


**15.3.1** **Time-base unit**


The main block of the programmable timer is a 16-bit upcounter with its related auto-reload
register. The counter clock can be divided by a prescaler.


The counter, the auto-reload register and the prescaler register can be written or read by
software. This is true even when the counter is running.


The time-base unit includes:


      - Counter Register (TIMx_CNT)


      - Prescaler Register (TIMx_PSC)


      - Auto-Reload Register (TIMx_ARR)


The auto-reload register is preloaded. The preload register is accessed each time an
attempt is made to write or read the auto-reload register. The contents of the preload
register are transferred into the shadow register permanently or at each update event UEV,
depending on the auto-reload preload enable bit (ARPE) in the TIMx_CR1 register. The
update event is sent when the counter reaches the overflow value and if the UDIS bit equals
0 in the TIMx_CR1 register. It can also be generated by software. The generation of the
update event is described in detail for each configuration.


The counter is clocked by the prescaler output CK_CNT, which is enabled only when the
counter enable bit (CEN) in the TIMx_CR1 register is set.


Note that the actual counter enable signal CNT_EN is set 1 clock cycle after CEN.


**Prescaler description**


The prescaler can divide the counter clock frequency by any factor between 1 and 65536. It
is based on a 16-bit counter controlled through a 16-bit register (in the TIMx_PSC register).
It can be changed on the fly as the TIMx_PSC control register is buffered. The new
prescaler ratio is taken into account at the next update event.


_Figure 140_ and _Figure 141_ give some examples of the counter behavior when the prescaler
ratio is changed on the fly.


368/775 RM0360 Rev 5


**RM0360** **Basic timer (TIM6/TIM7)**


**Figure 140. Counter timing diagram with prescaler division change from 1 to 2**







|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|F8|F9|FA|FB|FC|00|00|01|01|01|02|02|02|03|03|
|F8|F9|FA|FB|FC|||||||||||
|F8|||||||||||||||
|F8|||||||||||||||
|F8|||||||||||||||
|F8|||||||||||||||
|F8|||||0|1|0|1|0|0|1|0|0|1|


**Figure 141. Counter timing diagram with prescaler division change from 1 to 4**











|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|F8|F8|F9|FA|FB|FC|00|00|00|00|01|01|01|01|
|F8|F8|F9|FA|FB|FC|||||||||
|F8||||||||||||||
|F8||||||||||||||
|F8||||||||||||||
|F8||||||||||||||
|F8||||||0|1|2|3|0|1|2|3|


RM0360 Rev 5 369/775



379


**Basic timer (TIM6/TIM7)** **RM0360**


**15.3.2** **Counter modes**


The counter counts from 0 to the auto-reload value (contents of the TIMx_ARR register),
then restarts from 0 and generates a counter overflow event.


An update event can be generate at each counter overflow or by setting the UG bit in the
TIMx_EGR register (by software or by using the slave mode controller).


The UEV event can be disabled by software by setting the UDIS bit in the TIMx_CR1
register. This avoids updating the shadow registers while writing new values into the preload
registers. In this way, no update event occurs until the UDIS bit has been written to 0,
however, the counter and the prescaler counter both restart from 0 (but the prescale rate
does not change). In addition, if the URS (update request selection) bit in the TIMx_CR1
register is set, setting the UG bit generates an update event UEV, but the UIF flag is not set
(so no interrupt or DMA request is sent).


When an update event occurs, all the registers are updated and the update flag (UIF bit in
the TIMx_SR register) is set (depending on the URS bit):


      - The buffer of the prescaler is reloaded with the preload value (contents of the
TIMx_PSC register)


      - The auto-reload shadow register is updated with the preload value (TIMx_ARR)


The following figures show some examples of the counter behavior for different clock
frequencies when TIMx_ARR = 0x36.


**Figure 142. Counter timing diagram, internal clock divided by 1**






|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|
|---|---|---|---|---|---|---|---|---|---|---|---|---|
|32|33|34|35|36|00|01|02|03|04|05|06|07|



370/775 RM0360 Rev 5


**RM0360** **Basic timer (TIM6/TIM7)**


**Figure 143. Counter timing diagram, internal clock divided by 2**









**Figure 144. Counter timing diagram, internal clock divided by 4**





RM0360 Rev 5 371/775



379


**Basic timer (TIM6/TIM7)** **RM0360**


**Figure 145. Counter timing diagram, internal clock divided by N**









**Figure 146. Counter timing diagram, update event when ARPE = 0**
**(TIMx_ARR not preloaded)**









372/775 RM0360 Rev 5




**RM0360** **Basic timer (TIM6/TIM7)**


**Figure 147. Counter timing diagram, update event when ARPE=1**
**(TIMx_ARR preloaded)**






|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|
|---|---|---|---|---|---|---|---|
|F1|F2|F3|F4|F5|00|01|02|









RM0360 Rev 5 373/775



379


**Basic timer (TIM6/TIM7)** **RM0360**


**15.3.3** **Clock source**


The counter clock is provided by the Internal clock (CK_INT) source.


The CEN (in the TIMx_CR1 register) and UG bits (in the TIMx_EGR register) are actual
control bits and can be changed only by software (except for UG that remains cleared
automatically). As soon as the CEN bit is written to 1, the prescaler is clocked by the internal
clock CK_INT.


_Figure 148_ shows the behavior of the control circuit and the upcounter in normal mode,
without prescaler.


**Figure 148. Control circuit in normal mode, internal clock divided by 1**



**15.3.4** **Debug mode**




|Col1|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|||||||||||||||
|||||||||||||||
|||||||||||||||
|31|3 2|33|34|35|36|00|01|02|03|04|05|06|07|



When the microcontroller enters the debug mode (Cortex™-M0 core - halted), the TIMx
counter either continues to work normally or stops, depending on the DBG_TIMx_STOP
configuration bit in the DBG module.


374/775 RM0360 Rev 5


**RM0360** **Basic timer (TIM6/TIM7)**

# **15.4 TIM6/TIM7 registers**


Refer to _Section 1.2 on page 33_ for a list of abbreviations used in register descriptions.


The peripheral registers can be accessed by half-words (16-bit) or words (32-bit).


**15.4.1** **TIM6/TIM7 control register 1 (TIMx_CR1)**


Address offset: 0x00


Reset value: 0x0000

|15|14|13|12|11|10|9|8|7|6|5|4|3|2|1|0|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|ARPE|Res.|Res.|Res.|OPM|URS|UDIS|CEN|
|||||||||rw||||rw|rw|rw|rw|



Bits 15:8 Reserved, always read as 0.


Bit 7 **ARPE** : Auto-reload preload enable


0: TIMx_ARR register is not buffered.
1: TIMx_ARR register is buffered.


Bits 6:4 Reserved, always read as 0.


Bit 3 **OPM** : One-pulse mode


0: Counter is not stopped at update event
1: Counter stops counting at the next update event (clearing the CEN bit).


Bit 2 **URS** : Update request source

This bit is set and cleared by software to select the UEV event sources.


0: Any of the following events generates an update interrupt or DMA request if enabled.
These events can be:

– Counter overflow/underflow

–
Setting the UG bit

–
Update generation through the slave mode controller


1: Only counter overflow/underflow generates an update interrupt or DMA request if
enabled.


Bit 1 **UDIS** : Update disable

This bit is set and cleared by software to enable/disable UEV event generation.


0: UEV enabled. The Update (UEV) event is generated by one of the following events:

– Counter overflow/underflow

–
Setting the UG bit

–
Update generation through the slave mode controller


Buffered registers are then loaded with their preload values.


1: UEV disabled. The Update event is not generated, shadow registers keep their value
(ARR, PSC). However the counter and the prescaler are reinitialized if the UG bit is set or if
a hardware reset is received from the slave mode controller.


Bit 0 **CEN** : Counter enable

0: Counter disabled

1: Counter enabled

_Note: Gated mode can work only if the CEN bit has been previously set by software._
_However trigger mode can set the CEN bit automatically by hardware._

CEN is cleared automatically in one-pulse mode, when an update event occurs.


RM0360 Rev 5 375/775



379


**Basic timer (TIM6/TIM7)** **RM0360**


**15.4.2** **TIM6/TIM7 DMA/Interrupt enable register (TIMx_DIER)**


Address offset: 0x0C


Reset value: 0x0000

|15|14|13|12|11|10|9|8|7|6|5|4|3|2|1|0|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|Res.|Res.|Res.|Res.|Res.|Res.|Res.|UDE|Res.|Res.|Res.|Res.|Res.|Res.|Res.|UIE|
||||||||rw||||||||rw|



Bits 15:9 Reserved, must be kept at reset value.


Bit 8 **UDE** : Update DMA request enable


0: Update DMA request disabled.
1: Update DMA request enabled.


Bits 7:1 Reserved, must be kept at reset value.


Bit 0 **UIE** : Update interrupt enable


0: Update interrupt disabled.
1: Update interrupt enabled.


376/775 RM0360 Rev 5


**RM0360** **Basic timer (TIM6/TIM7)**


**15.4.3** **TIM6/TIM7 status register (TIMx_SR)**


Address offset: 0x10


Reset value: 0x0000

|15|14|13|12|11|10|9|8|7|6|5|4|3|2|1|0|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|UIF|
||||||||||||||||rc_w0|



Bits 15:1 Reserved, must be kept at reset value.


Bit 0 **UIF** : Update interrupt flag

This bit is set by hardware on an update event. It is cleared by software.


0: No update occurred.
1: Update interrupt pending. This bit is set by hardware when the registers are updated:

–At overflow or underflow regarding the repetition counter value and if UDIS = 0 in the
TIMx_CR1 register.

–When CNT is reinitialized by software using the UG bit in the TIMx_EGR register, if
URS = 0 and UDIS = 0 in the TIMx_CR1 register.


**15.4.4** **TIM6/TIM7 event generation register (TIMx_EGR)**


Address offset: 0x14


Reset value: 0x0000

|15|14|13|12|11|10|9|8|7|6|5|4|3|2|1|0|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|UG|
||||||||||||||||w|



Bits 15:1 Reserved, must be kept at reset value.


Bit 0 **UG** : Update generation

This bit can be set by software, it is automatically cleared by hardware.


0: No action.

1: Re-initializes the timer counter and generates an update of the registers. Note that the
prescaler counter is cleared too (but the prescaler ratio is not affected).


**15.4.5** **TIM6/TIM7 counter (TIMx_CNT)**


Address offset: 0x24


Reset value: 0x0000

|15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|
|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|



Bits 15:0 **CNT[15:0]** : Counter value


RM0360 Rev 5 377/775



379


**Basic timer (TIM6/TIM7)** **RM0360**


**15.4.6** **TIM6/TIM7 prescaler (TIMx_PSC)**


Address offset: 0x28


Reset value: 0x0000

|15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|
|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|



Bits 15:0 **PSC[15:0]** : Prescaler value
The counter clock frequency CK_CNT is equal to f CK_PSC / (PSC[15:0] + 1).
PSC contains the value to be loaded into the active prescaler register at each update event.


**15.4.7** **TIM6/TIM7 auto-reload register (TIMx_ARR)**


Address offset: 0x2C


Reset value: 0xFFFF

|15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0|Col2|Col3|Col4|Col5|Col6|Col7|Col8|Col9|Col10|Col11|Col12|Col13|Col14|Col15|Col16|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|ARR[15:0]|
|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|rw|



Bits 15:0 **ARR[15:0]** : Auto-reload value

ARR is the value to be loaded into the actual auto-reload register.
Refer to _Section 15.3.1: Time-base unit on page 368_ for more details about ARR update and
behavior.

The counter is blocked while the auto-reload value is null.


378/775 RM0360 Rev 5


**RM0360** **Basic timer (TIM6/TIM7)**


**15.4.8** **TIM6/TIM7 register map**


TIMx registers are mapped as 16-bit addressable registers as described in the table below:


**Table 51. TIM6/TIM7 register map and reset values**



















|Offset|Register|31|30|29|28|27|26|25|24|23|22|21|20|19|18|17|16|15|14|13|12|11|10|9|8|7|6|5|4|3|2|1|0|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|0x00|**TIMx_CR1**|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|ARPE|Res.|Res.|Res.|OPM|URS|UDIS|CEN|
|0x00|Reset value|||||||||||||||||||||||||0||||0|0|0|0|
|0x0C|**TIMx_DIER**|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|UDE|Res.|Res.|Res.|Res.|Res.|Res.|Res.|UIE|
|0x0C|Reset value||||||||||||||||||||||||0||||||||0|
|0x10|**TIMx_SR**|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|UIF|
|0x10|Reset value||||||||||||||||||||||||||||||||0|
|0x14|**TIMx_EGR**|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|UG|
|0x14|Reset value||||||||||||||||||||||||||||||||0|
|0x24|**TIMx_CNT**|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|CNT[15:0]|
|0x24|Reset value|||||||||||||||||0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|
|0x28|**TIMx_PSC**|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|PSC[15:0]|
|0x28|Reset value|||||||||||||||||0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|
|0x2C|**TIMx_ARR**|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|Res.|ARR[15:0]<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1|ARR[15:0]<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1|ARR[15:0]<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1|ARR[15:0]<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1|ARR[15:0]<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1|ARR[15:0]<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1|ARR[15:0]<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1|ARR[15:0]<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1|ARR[15:0]<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1|ARR[15:0]<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1|ARR[15:0]<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1|ARR[15:0]<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1|ARR[15:0]<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1|ARR[15:0]<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1|ARR[15:0]<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1|ARR[15:0]<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1<br>1|
|0x2C|Reset value|||||||||||||||||||||||||||||||||


Refer to _Section 2.2 on page 37_ for the register boundary addresses.


RM0360 Rev 5 379/775



379


